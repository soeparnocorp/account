<!DOCTYPE html>
<!--
  WhatsApp-style Flow: Name ‚Üí Create Room ‚Üí Conversation List ‚Üí Chat Room
  FIXED: Desktop dual-view, Mobile single-view
  ENHANCED: Matrix Element-like textarea with markdown support
-->

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style type="text/css">
      * { box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        margin: 0; padding: 0;
        background-color: #f0f2f5; color: #111b21;
      }

      /* ===== LAYER SYSTEM ===== */
      .app-layer {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: white;
        overflow: hidden;
        transition: transform 0.3s ease;
      }

      /* Layer 1: Conversation List */
      #conversation-list {
        z-index: 10;
        display: flex;
        flex-direction: column;
      }

      /* Layer 2: Chat Room */
      #chat-room {
        z-index: 20;
        background-color: #efeae2;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23000000' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
        display: none;
      }

      /* ===== CONVERSATION LIST STYLES ===== */
      .list-header {
        padding: 16px;
        background: #ff0000;
        color: white;
      }
      .list-header h1 {
        margin: 0;
        font-size: 20px;
      }

      .your-name-card {
        padding: 20px 16px;
        border-bottom: 1px solid #e0e0e0;
        background: #f8f9fa;
      }
      .name-label {
        font-size: 12px;
        color: #667781;
        margin-bottom: 4px;
      }
      .name-value {
        font-size: 18px;
        font-weight: 600;
        color: #111b21;
      }

      .rooms-section {
        flex: 1;
        overflow-y: auto;
        padding: 0;
      }
      .room-item {
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }
      .room-item:hover {
        background: #f5f5f5;
      }
      .room-name {
        font-weight: 600;
        color: #111b21;
        margin-bottom: 4px;
      }
      .room-meta {
        font-size: 13px;
        color: #667781;
      }

      /* ===== CHAT ROOM STYLES ===== */
      .chat-header {
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 60px;
        background: #ff0000;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 16px;
        z-index: 30;
      }
      .back-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        margin-right: 12px;
        display: none; /* Hidden by default, shown on mobile */
      }
      .room-title {
        font-weight: 600;
        font-size: 17px;
      }

      #chatlog {
        position: absolute;
        top: 60px;
        bottom: 72px; /* More space for enhanced input */
        left: 0; right: 0;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
      }
      #spacer { height: 20px; }

      /* ===== MATRIX ELEMENT-LIKE TEXTAREA ===== */
      .input-container {
        position: absolute;
        bottom: 0; left: 0; right: 0;
        background: #ffffff;
        border-top: 1px solid #e0e0e0;
        padding: 12px 16px;
        min-height: 72px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }

      .textarea-wrapper {
        display: flex;
        align-items: flex-end;
        background: #f0f2f5;
        border-radius: 20px;
        padding: 8px 16px;
        border: 1px solid #e0e0e0;
        transition: border-color 0.2s, box-shadow 0.2s;
        min-height: 40px;
      }

      .textarea-wrapper:focus-within {
        border-color: #ff0000;
        box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.1);
        background: #ffffff;
      }

      #chat-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 16px;
        line-height: 1.5;
        resize: none;
        font-family: inherit;
        background: transparent;
        max-height: 120px;
        overflow-y: auto;
        padding: 4px 0;
        margin: 0;
        min-height: 24px;
        color: #111b21;
      }

      #chat-input::placeholder {
        color: #667781;
        opacity: 0.8;
      }

      .send-button {
        background: #ff0000;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
        margin-left: 12px;
        flex-shrink: 0;
        font-weight: bold;
        font-size: 18px;
      }

      .send-button:hover {
        background: #e60000;
      }

      .send-button:active {
        transform: scale(0.95);
      }

      .send-button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
      }

      /* Formatting toolbar (Matrix Element style) */
      .formatting-toolbar {
        display: flex;
        gap: 4px;
        margin-bottom: 8px;
        padding: 0 4px;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .formatting-toolbar:hover {
        opacity: 1;
      }

      .format-button {
        background: none;
        border: none;
        color: #667781;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        transition: background 0.2s, color 0.2s;
      }

      .format-button:hover {
        background: #f0f2f5;
        color: #111b21;
      }

      .format-button.active {
        background: #ff0000;
        color: white;
      }

      /* Message preview */
      .message-preview {
        margin-top: 8px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
        color: #667781;
        border-left: 3px solid #ff0000;
        display: none;
      }

      .message-preview.show {
        display: block;
      }

      /* Message bubbles */
      #chatlog p {
        max-width: 65%;
        margin: 8px 0;
        padding: 8px 12px;
        border-radius: 7.5px;
        line-height: 1.4;
        word-wrap: break-word;
        opacity: 0;
        transform: translateY(10px);
        animation: messageAppear 0.2s ease forwards;
      }
      
      @keyframes messageAppear {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      #chatlog p:has(> .username) {
        background: #ff0000;
        color: white;
        margin-left: auto;
        margin-right: 0;
        border-top-right-radius: 0;
      }
      #chatlog p:not(:has(> .username)) {
        background: white;
        color: #111b21;
        margin-right: auto;
        margin-left: 0;
        border-top-left-radius: 0;
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.05);
      }
      #chatlog p:not(:has(> .username)):not(:has(> span)) {
        background: transparent;
        color: #667781;
        text-align: center;
        font-style: italic;
        max-width: 100%;
        font-size: 14px;
        animation: none;
        opacity: 1;
        transform: none;
      }
      .username {
        font-weight: 600;
        color: #111b21;
      }

      /* Markdown styling in messages */
      .message-bold {
        font-weight: 700;
      }
      .message-italic {
        font-style: italic;
      }
      .message-code {
        font-family: 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.9em;
      }

      /* ===== FORM STYLES ===== */
      .form-layer {
        position: fixed;
        z-index: 100;
        top: 0; bottom: 0; left: 0; right: 0;
        background: #f0f2f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .form-input {
        font-size: 24px;
        padding: 16px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        width: 400px;
        max-width: 90%;
        margin-bottom: 20px;
        background: white;
        text-align: center;
      }
      .form-input:focus {
        border-color: #ff0000;
        outline: none;
      }
      .form-button {
        font-size: 20px;
        padding: 16px 32px;
        margin: 10px;
        border: none;
        border-radius: 24px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
      }
      .form-button.primary {
        background: #ff0000;
        color: white;
        width: 180px;
      }
      .form-button.secondary {
        background: white;
        color: #ff0000;
        border: 2px solid #ff0000 !important;
        width: 280px;
      }
      .form-button:hover {
        transform: translateY(-2px);
      }
      .form-button:active {
        transform: translateY(0);
      }
      .form-text {
        text-align: center;
        color: #667781;
        max-width: 600px;
        line-height: 1.6;
        font-size: 16px;
      }
      .form-text a {
        color: #ff0000;
        text-decoration: none;
        font-weight: 600;
      }
      .form-text a:hover { text-decoration: underline; }

      /* ===== DESKTOP LAYOUT ===== */
      @media(min-width:901px) {
        body {
          display: flex;
        }
        
        #conversation-list {
          width: 300px;
          border-right: 1px solid #e0e0e0;
          display: flex !important;
          position: relative !important;
          transform: none !important;
        }
        
        #chat-room {
          left: 300px;
          width: calc(100% - 300px);
          display: block !important;
          position: relative !important;
          transform: none !important;
        }
        
        .back-btn {
          display: none !important;
        }
        
        /* Forms appear in conversation list area on desktop */
        .form-layer {
          position: absolute;
          background: white;
          z-index: 5;
        }
      }

      /* ===== MOBILE LAYOUT ===== */
      @media(max-width:900px) {
        .form-input, .form-layer { font-size: 20px; }
        .form-text { font-size: 14px; }
        .form-input {
          height: 50px;
          width: 300px;
        }
        .form-button {
          font-size: 18px;
          padding: 14px 24px;
        }
        .form-button.primary { width: 150px; }
        .form-button.secondary { width: 240px; }
        
        .back-btn {
          display: block !important;
        }
        
        .input-container {
          padding: 8px 12px;
        }
        
        .textarea-wrapper {
          padding: 6px 12px;
        }
        
        .formatting-toolbar {
          display: none; /* Hide formatting on mobile for simplicity */
        }
      }

      @media(max-width:500px) {
        .form-input, .form-layer { font-size: 18px; }
        .form-text { font-size: 13px; }
        .form-input {
          height: 48px;
          width: 280px;
        }
        .form-button {
          font-size: 16px;
          padding: 12px 20px;
        }
        .form-button.primary { width: 130px; }
        .form-button.secondary { width: 220px; }
      }

      /* Scrollbar */
      #chatlog::-webkit-scrollbar { width: 6px; }
      #chatlog::-webkit-scrollbar-track { background: transparent; }
      #chatlog::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 3px; }
      #chatlog::-webkit-scrollbar-thumb:hover { background: #b3b3b3; }
      
      .rooms-section::-webkit-scrollbar { width: 4px; }
      .rooms-section::-webkit-scrollbar-track { background: transparent; }
      .rooms-section::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }

      ::selection {
        background-color: rgba(255, 0, 0, 0.2);
      }
      
      /* Typing indicator */
      .typing-indicator {
        display: flex;
        align-items: center;
        padding: 0 16px;
        margin: 8px 0;
        opacity: 0.7;
        font-size: 14px;
        color: #667781;
      }
      
      .typing-dot {
        width: 8px;
        height: 8px;
        background: #667781;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.4s infinite;
      }
      
      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }
      
      @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
      }
    </style>
  </head>

  <body>
    <!-- FORM 1: Input Name -->
    <form id="name-form" class="form-layer">
      <input id="name-input" class="form-input" placeholder="your name">
      <p class="form-text">
        This chat runs entirely on the edge<br>
        <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">Durable Objects</a>
      </p>
    </form>

    <!-- FORM 2: Create Room -->
    <form id="room-form" class="form-layer" style="display: none;">
      <p class="form-text">Public Room:</p>
      <input id="room-name" class="form-input" placeholder="room name">
      <button id="go-public" class="form-button primary">Go &raquo;</button>
      <p class="form-text">OR</p>
      <button id="go-private" class="form-button secondary">Private Room &raquo;</button>
    </form>

    <!-- LAYER 1: Conversation List -->
    <div id="conversation-list" class="app-layer" style="display: none;">
      <div class="list-header">
        <h1>READTalk</h1>
      </div>
      
      <div class="your-name-card">
        <div class="name-label">You are</div>
        <div id="display-username" class="name-value">(not set)</div>
      </div>
      
      <div class="rooms-section" id="rooms-container">
        <!-- Rooms will be added here dynamically -->
        <div class="room-item" id="default-room-message" style="padding: 40px 20px; text-align: center; color: #667781;">
          Create your first room to start chatting
        </div>
      </div>
    </div>

    <!-- LAYER 2: Chat Room -->
    <div id="chat-room" class="app-layer">
      <div class="chat-header">
        <button class="back-btn">‚Üê</button>
        <div id="chat-room-title" class="room-title">Chat Room</div>
      </div>
      
      <div id="chatlog">
        <div id="spacer"></div>
      </div>
      
      <!-- Matrix Element-like input area -->
      <div class="input-container">
        <div class="formatting-toolbar">
          <button class="format-button" data-format="bold" title="Bold">B</button>
          <button class="format-button" data-format="italic" title="Italic">I</button>
          <button class="format-button" data-format="code" title="Code">{"}</button>
        </div>
        
        <div class="textarea-wrapper">
          <textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
          <button id="send-button" class="send-button" disabled>‚Üí</button>
        </div>
        
        <div id="message-preview" class="message-preview"></div>
      </div>
    </div>

    <script type="text/javascript">
      // ===== GLOBAL STATE =====
      let currentWebSocket = null;
      let username = '';
      let roomname = '';
      let currentActiveRoom = null;
      let roomsHistory = [];
      let isDesktop = window.innerWidth > 900;
      
      let hostname = window.location.host;
      if (hostname === '') {
        hostname = 'room.soeparnocorp.workers.dev';
      }

      // ===== DOM ELEMENTS =====
      const nameForm = document.getElementById('name-form');
      const nameInput = document.getElementById('name-input');
      const roomForm = document.getElementById('room-form');
      const roomNameInput = document.getElementById('room-name');
      const goPublicButton = document.getElementById('go-public');
      const goPrivateButton = document.getElementById('go-private');
      const conversationList = document.getElementById('conversation-list');
      const chatRoom = document.getElementById('chat-room');
      const chatlog = document.getElementById('chatlog');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');
      const backBtn = document.querySelector('.back-btn');
      const chatRoomTitle = document.getElementById('chat-room-title');
      const displayUsername = document.getElementById('display-username');
      const roomsContainer = document.getElementById('rooms-container');
      const defaultRoomMessage = document.getElementById('default-room-message');
      const messagePreview = document.getElementById('message-preview');
      const formatButtons = document.querySelectorAll('.format-button');

      let isAtBottom = true;
      let lastSeenTimestamp = 0;
      let wroteWelcomeMessages = false;

      // ===== INITIAL SETUP =====
      function setupInitialLayout() {
        if (isDesktop) {
          // DESKTOP: Show both views
          conversationList.style.display = 'flex';
          chatRoom.style.display = 'block';
          backBtn.style.display = 'none';
          
          // Set initial state
          chatRoomTitle.textContent = 'Select a conversation';
          chatInput.disabled = true;
          chatInput.placeholder = 'Select a conversation to start messaging';
          sendButton.disabled = true;
        }
      }

      // ===== ROOM HISTORY MANAGEMENT =====
      function saveRoomToHistory(roomName, isPrivate = false) {
        roomsHistory = roomsHistory.filter(r => r.name !== roomName);
        roomsHistory.unshift({
          name: roomName,
          type: isPrivate ? 'private' : 'public',
          timestamp: Date.now()
        });
        
        renderRoomsList();
      }

      function renderRoomsList() {
        if (roomsHistory.length === 0) {
          defaultRoomMessage.style.display = 'block';
          return;
        }
        
        defaultRoomMessage.style.display = 'none';
        roomsContainer.innerHTML = '';
        
        roomsHistory.forEach(room => {
          const roomItem = document.createElement('div');
          roomItem.className = 'room-item';
          roomItem.dataset.room = room.name;
          roomItem.dataset.type = room.type;
          
          // Highlight active room on desktop
          if (isDesktop && currentActiveRoom === room.name) {
            roomItem.style.background = '#e8f4fd';
          }
          
          const roomNameDiv = document.createElement('div');
          roomNameDiv.className = 'room-name';
          roomNameDiv.textContent = room.type === 'private' 
            ? `üîí ${room.name.substring(0, 8)}...` 
            : `#${room.name}`;
          
          const roomMeta = document.createElement('div');
          roomMeta.className = 'room-meta';
          roomMeta.textContent = room.type === 'private' 
            ? 'Private room ‚Ä¢ Click to open' 
            : 'Public room ‚Ä¢ Click to open';
          
          roomItem.appendChild(roomNameDiv);
          roomItem.appendChild(roomMeta);
          roomsContainer.appendChild(roomItem);
        });
      }

      // ===== LAYER NAVIGATION (FIXED: Desktop Dual-View) =====
      function showConversationList() {
        nameForm.style.display = 'none';
        roomForm.style.display = 'none';
        
        if (isDesktop) {
          // DESKTOP: Only show conversation list, chat room stays visible
          conversationList.style.display = 'flex';
          // Chat room remains visible with empty state
          chatRoomTitle.textContent = 'Select a conversation';
          chatInput.disabled = true;
          chatInput.placeholder = 'Select a conversation to start messaging';
          sendButton.disabled = true;
          currentActiveRoom = null;
        } else {
          // MOBILE: Toggle views
          conversationList.style.display = 'flex';
          chatRoom.style.display = 'none';
        }
        
        if (username) {
          displayUsername.textContent = username;
        }
      }

      function openChatRoom(roomName) {
        currentActiveRoom = roomName;
        
        if (isDesktop) {
          // DESKTOP: Update chat room content, conversation list stays visible
          renderRoomsList();
        } else {
          // MOBILE: Hide conversation list
          conversationList.style.display = 'none';
        }
        
        // Show chat room
        chatRoom.style.display = 'block';
        chatRoomTitle.textContent = roomName.length === 64 
          ? `üîí ${roomName.substring(0, 8)}...`
          : `#${roomName}`;
        
        // Clear chat log
        chatlog.innerHTML = '<div id="spacer"></div>';
        
        // Set global roomname
        roomname = roomName;
        document.location.hash = `#${roomName}`;
        wroteWelcomeMessages = false;
        
        // Enable input
        chatInput.disabled = false;
        chatInput.placeholder = 'Type a message...';
        sendButton.disabled = false;
        
        // Connect WebSocket
        if (currentWebSocket) {
          currentWebSocket.close();
        }
        join();
        
        // Focus input
        setTimeout(() => {
          chatInput.focus();
          scrollToBottom(true);
        }, 100);
      }

      // ===== MATRIX ELEMENT TEXTAREA FEATURES =====
      function setupTextareaFeatures() {
        // Auto-resize
        chatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          const newHeight = Math.min(this.scrollHeight, 120);
          this.style.height = newHeight + 'px';
          
          // Show/hide preview
          const text = this.value.trim();
          if (text.length > 0 && text.length < 100) {
            messagePreview.textContent = `Preview: ${text}`;
            messagePreview.classList.add('show');
          } else {
            messagePreview.classList.remove('show');
          }
        });
        
        // Formatting buttons
        formatButtons.forEach(button => {
          button.addEventListener('click', function() {
            const format = this.dataset.format;
            const start = chatInput.selectionStart;
            const end = chatInput.selectionEnd;
            const text = chatInput.value;
            let newText, newCursorPos;
            
            switch(format) {
              case 'bold':
                newText = text.substring(0, start) + '**' + 
                         text.substring(start, end) + '**' + 
                         text.substring(end);
                newCursorPos = end + 4;
                break;
              case 'italic':
                newText = text.substring(0, start) + '*' + 
                         text.substring(start, end) + '*' + 
                         text.substring(end);
                newCursorPos = end + 2;
                break;
              case 'code':
                newText = text.substring(0, start) + '`' + 
                         text.substring(start, end) + '`' + 
                         text.substring(end);
                newCursorPos = end + 2;
                break;
            }
            
            chatInput.value = newText;
            chatInput.focus();
            chatInput.setSelectionRange(newCursorPos, newCursorPos);
            
            // Trigger resize
            chatInput.dispatchEvent(new Event('input'));
          });
        });
        
        // Enter to send, Shift+Enter for new line
        chatInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendButton.disabled && chatInput.value.trim()) {
              sendMessage();
            }
          }
        });
        
        // Send button
        sendButton.addEventListener('click', sendMessage);
      }

      // ===== MARKDOWN PARSING =====
      function parseMarkdown(text) {
        // Simple markdown parsing for display
        return text
          .replace(/\*\*(.*?)\*\*/g, '<span class="message-bold">$1</span>')
          .replace(/\*(.*?)\*/g, '<span class="message-italic">$1</span>')
          .replace(/`(.*?)`/g, '<span class="message-code">$1</span>');
      }

      // ===== FORM FLOW =====
      function startNameChooser() {
        if (isDesktop) {
          nameForm.style.display = 'flex';
          nameForm.style.position = 'absolute';
          nameForm.style.background = 'white';
        } else {
          nameForm.style.display = 'flex';
        }
        
        nameForm.addEventListener('submit', event => {
          event.preventDefault();
          username = nameInput.value.trim();
          if (username.length > 0) {
            startRoomChooser();
          }
        });

        nameInput.addEventListener('input', event => {
          if (event.currentTarget.value.length > 32) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 32);
          }
        });

        nameInput.focus();
      }

      function startRoomChooser() {
        nameForm.style.display = 'none';
        
        if (isDesktop) {
          roomForm.style.display = 'flex';
          roomForm.style.position = 'absolute';
          roomForm.style.background = 'white';
        } else {
          roomForm.style.display = 'flex';
        }

        if (document.location.hash.length > 1) {
          roomname = document.location.hash.slice(1);
          const isPrivate = roomname.match(/^[0-9a-f]{64}$/);
          saveRoomToHistory(roomname, isPrivate);
          showConversationList();
          return;
        }

        roomForm.addEventListener('submit', event => {
          event.preventDefault();
          roomname = roomNameInput.value.trim();
          if (roomname.length > 0) {
            saveRoomToHistory(roomname, false);
            showConversationList();
          }
        });

        roomNameInput.addEventListener('input', event => {
          if (event.currentTarget.value.length > 32) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 32);
          }
        });

        goPublicButton.addEventListener('click', event => {
          event.preventDefault();
          roomname = roomNameInput.value.trim();
          if (roomname.length > 0) {
            saveRoomToHistory(roomname, false);
            showConversationList();
          }
        });

        goPrivateButton.addEventListener('click', async event => {
          event.preventDefault();
          roomNameInput.disabled = true;
          goPublicButton.disabled = true;
          event.currentTarget.disabled = true;

          try {
            const response = await fetch(`https://${hostname}/api/room`, {
              method: 'POST'
            });
            
            if (!response.ok) throw new Error('Failed to create private room');
            
            roomname = await response.text();
            saveRoomToHistory(roomname, true);
            showConversationList();
          } catch (error) {
            alert('Something went wrong');
            document.location.reload();
          }
        });

        roomNameInput.focus();
      }

      // ===== CHAT FUNCTIONALITY =====
      function setupChatListeners() {
        backBtn.addEventListener('click', () => {
          if (currentWebSocket) {
            currentWebSocket.close();
            currentWebSocket = null;
          }
          showConversationList();
        });

        // Room item clicks
        roomsContainer.addEventListener('click', event => {
          const roomItem = event.target.closest('.room-item');
          if (roomItem) {
            const roomName = roomItem.dataset.room;
            openChatRoom(roomName);
          }
        });

        // Scroll management
        chatlog.addEventListener('scroll', checkScrollPosition);
        
        // Click to focus input
        chatRoom.addEventListener('click', (e) => {
          if (e.target !== chatInput && !chatInput.parentElement.contains(e.target)) {
            chatInput.focus();
          }
        });

        // Window resize
        window.addEventListener('resize', () => {
          const wasDesktop = isDesktop;
          isDesktop = window.innerWidth > 900;
          
          if (wasDesktop !== isDesktop) {
            // Update back button visibility
            backBtn.style.display = isDesktop ? 'none' : 'block';
          }
        });
      }

      function scrollToBottom(force = false) {
        if (!isAtBottom && !force) return;
        
        requestAnimationFrame(() => {
          chatlog.scrollTop = chatlog.scrollHeight;
          isAtBottom = true;
        });
      }

      function checkScrollPosition() {
        const threshold = 100;
        const scrollBottom = chatlog.scrollHeight - chatlog.scrollTop - chatlog.clientHeight;
        isAtBottom = scrollBottom <= threshold;
      }

      // ===== WEBSOCKET HANDLING =====
      function join() {
        const wss = document.location.protocol === 'http:' ? 'ws://' : 'wss://';
        const ws = new WebSocket(`${wss}${hostname}/api/room/${roomname}/websocket`);
        let rejoined = false;
        let startTime = Date.now();

        const rejoin = async () => {
          if (!rejoined) {
            rejoined = true;
            currentWebSocket = null;

            const timeSinceLastJoin = Date.now() - startTime;
            if (timeSinceLastJoin < 10000) {
              await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
            }

            join();
          }
        };

        ws.addEventListener('open', () => {
          currentWebSocket = ws;
          ws.send(JSON.stringify({ name: username }));
        });

        ws.addEventListener('message', event => {
          const data = JSON.parse(event.data);

          if (data.error) {
            addChatMessage(null, `* Error: ${data.error}`);
          } else if (data.joined) {
            // Could add "X joined" message
          } else if (data.quit) {
            // Could add "X left" message
          } else if (data.ready) {
            if (!wroteWelcomeMessages) {
              wroteWelcomeMessages = true;
              addChatMessage(null,
                '* ¬© 2026 SOEPARNO ENTERPRISE Corp. Alright Reserved. ' +
                'Source: https://github.com/soeparnocorp/room');
              addChatMessage(null,
                '* WARNING: Participants are random people on the internet. ' +
                'Names are not authenticated. Chat history is saved.');
              if (roomname.length === 64) {
                addChatMessage(null, '* This is a private room. Share the URL to invite others.');
              } else {
                addChatMessage(null, `* Welcome to #${roomname}. Say hi!`);
              }
            }
          } else {
            if (data.timestamp > lastSeenTimestamp) {
              addChatMessage(data.name, data.message);
              lastSeenTimestamp = data.timestamp;
            }
          }
        });

        ws.addEventListener('close', () => {
          console.log('WebSocket closed, reconnecting');
          rejoin();
        });

        ws.addEventListener('error', () => {
          console.log('WebSocket error, reconnecting');
          rejoin();
        });
      }

      function addChatMessage(name, text) {
        const p = document.createElement('p');
        if (name) {
          const tag = document.createElement('span');
          tag.className = 'username';
          tag.textContent = `${name}: `;
          p.appendChild(tag);
        }
        
        const messageContent = document.createElement('span');
        messageContent.innerHTML = parseMarkdown(text);
        p.appendChild(messageContent);

        chatlog.appendChild(p);
        scrollToBottom();
      }

      function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || !currentWebSocket || currentWebSocket.readyState !== WebSocket.OPEN) {
          return;
        }

        currentWebSocket.send(JSON.stringify({ message: message }));
        
        // Reset UI
        chatInput.value = '';
        chatInput.style.height = 'auto';
        messagePreview.classList.remove('show');
        
        // Focus for next message
        chatInput.focus();
      }

      // ===== INITIALIZATION =====
      function init() {
        setupInitialLayout();
        startNameChooser();
        setupChatListeners();
        setupTextareaFeatures();
        
        // Load existing rooms from hash
        if (document.location.hash.length > 1) {
          const roomFromHash = document.location.hash.slice(1);
          const isPrivate = roomFromHash.match(/^[0-9a-f]{64}$/);
          saveRoomToHistory(roomFromHash, isPrivate);
          
          // If desktop and hash exists, open that room
          if (isDesktop && roomFromHash) {
            setTimeout(() => openChatRoom(roomFromHash), 100);
          }
        }
      }

      // Start the app
      init();
    </script>
  </body>
</html>
