<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
* { box-sizing: border-box; }
body { font-family: Arial, Helvetica, sans-serif; margin:0; }

#sidebar {
  position: fixed;
  top: 0;
  bottom: 0;
  left: 0;
  width: 240px;
  background: #f9f9f9;
  border-right: 1px solid #ccc;
  padding: 16px;
  overflow-y: auto;
}

#name-room {
  margin-bottom: 16px;
}
#name-room input, #name-room button { margin-top: 4px; width: 100%; font-size: 1em; }

#search {
  margin-bottom: 16px;
}
#search input { width: 100%; font-size: 1em; }

#room-suggestions p {
  margin: 4px 0;
  cursor: pointer;
  padding: 2px 4px;
}
#room-suggestions p:hover { background: #ddd; }

#chat-container {
  margin-left: 240px;
  position: fixed;
  top: 0;
  bottom: 32px;
  right: 0;
  left: 240px;
  display: flex;
  flex-direction: column;
}

#chatlog {
  flex: 1;
  padding: 8px;
  overflow-y: auto;
  word-break: break-word;
}

#chat-input { 
  border: none; 
  border-top: 1px solid #ccc; 
  padding: 8px; 
  font-size: 1em; 
  width: 100%;
  box-sizing: border-box;
}

@media(max-width: 600px) {
  #sidebar { width: 160px; }
  #chat-container { margin-left: 160px; left: 160px; }
}
@media(max-width: 400px) {
  #sidebar { width: 100%; position: relative; height: auto; border-right:none; border-bottom:1px solid #ccc; }
  #chat-container { margin-left: 0; left: 0; top: calc(100px); }
}
</style>
  </head>
  <body>

<div id="sidebar">
  <div id="name-room">
    <input id="name-input" placeholder="Your name">
    <input id="room-name" placeholder="Room name">
    <button id="go-public">Go Public</button>
    <button id="go-private">Private Room</button>
  </div>
  <div id="search">
    <input id="room-search" placeholder="Search rooms">
    <div id="room-suggestions"></div>
  </div>
</div>

<div id="chat-container">
  <div id="chatlog"></div>
  <input id="chat-input" placeholder="Type a message">
</div>

<script>
let username, roomname, currentWebSocket=null;
let nameInput = document.querySelector("#name-input");
let roomNameInput = document.querySelector("#room-name");
let goPublicButton = document.querySelector("#go-public");
let goPrivateButton = document.querySelector("#go-private");
let chatInput = document.querySelector("#chat-input");
let chatlog = document.querySelector("#chatlog");
let roomSearchInput = document.querySelector("#room-search");
let roomSuggestions = document.querySelector("#room-suggestions");
let hostname = window.location.host || "room.soeparnocorp.workers.dev";

goPublicButton.addEventListener("click", () => startChat(roomNameInput.value));
goPrivateButton.addEventListener("click", async () => {
  let response = await fetch("https://"+hostname+"/api/room",{method:"POST"});
  if(response.ok) {
    startChat(await response.text());
  } else alert("Something went wrong");
});

function startChat(rname) {
  roomname = rname.replace(/[^a-zA-Z0-9_-]/g,"").replace(/_/g,"-").toLowerCase();
  document.location.hash = "#"+roomname;
  initWebSocket();
}

function initWebSocket() {
  let wss = location.protocol==="http:"?"ws://":"wss://";
  let ws = new WebSocket(wss+hostname+"/api/room/"+roomname+"/websocket");
  currentWebSocket = ws;

  ws.addEventListener("open",()=>ws.send(JSON.stringify({name:nameInput.value})));
  ws.addEventListener("message",e=>{
    let data=JSON.parse(e.data);
    if(data.message) addChatMessage(data.name,data.message);
  });
}

chatInput.addEventListener("keydown",e=>{
  if(e.key==="Enter" && currentWebSocket){
    e.preventDefault();
    currentWebSocket.send(JSON.stringify({message:chatInput.value}));
    chatInput.value="";
  }
});

function addChatMessage(name,text){
  let p=document.createElement("p");
  if(name){ let t=document.createElement("span"); t.className="username"; t.innerText=name+": "; p.appendChild(t); }
  p.appendChild(document.createTextNode(text));
  chatlog.appendChild(p);
  chatlog.scrollBy(0,1e8);
}

// Search suggestion (dummy fetch for demo, replace with KV/D1 fetch)
roomSearchInput.addEventListener("input",e=>{
  roomSuggestions.innerHTML="";
  let q = e.target.value.toLowerCase();
  if(!q) return;
  let rooms = ["room1","room2","room3","demo-room"]; // replace with real room names from KV/D1
  rooms.filter(r=>r.includes(q)).forEach(r=>{
    let p=document.createElement("p"); p.innerText=r;
    p.addEventListener("click",()=>startChat(r));
    roomSuggestions.appendChild(p);
  });
});
</script>
</body>
</html>
