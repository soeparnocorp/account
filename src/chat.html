<!DOCTYPE html>
<!--
  THIS IS NOT THE INTERESTING FILE

  This is just some UI code. There's nothing interesting and unique in this file. The interesting
  thing about this demo is the server side, which is in chat.mjs.

  WARNING: This was written by a systems engineer, not a web developer. It's probably bad.
-->

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<!--===================================================================================-->
<!-- Inline style to avoid an extra round trip before the page can render. -->
<style type="text/css">
* {
  box-sizing: border-box;
}
body {
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 0;
  height: 100vh;
  overflow: hidden;
}

/* App container */
#app-container {
  display: flex;
  height: 100vh;
}

/* Sidebar */
#sidebar {
  width: 300px;
  background: #f9f9f9;
  border-right: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Sidebar sections */
#room-search-container {
  padding: 12px;
  border-bottom: 1px solid #ddd;
}

#room-search {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

#room-results {
  margin-top: 8px;
  max-height: 200px;
  overflow-y: auto;
}

.room-result {
  padding: 6px 8px;
  margin: 2px 0;
  background: white;
  border: 1px solid #eee;
  border-radius: 3px;
  cursor: pointer;
  font-size: 13px;
}

.room-result:hover {
  background: #e6f7ff;
  border-color: #91d5ff;
}

#sidebar-roster {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  font-weight: bold;
}

/* Main chat area */
#chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#chatlog {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  overflow-wrap: break-word;
}

#chatlog span.username {
  font-weight: bold;
}

#chat-input-container {
  border-top: 1px solid #ddd;
  padding: 0;
}

#chat-input {
  width: 100%;
  height: 48px;
  border: none;
  padding: 0 16px;
  font-size: 16px;
  outline: none;
}

#chatroom::before {
  display: none;
}

/* Forms */
#name-form, #room-form {
  position: fixed;
  z-index: 100;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#name-input, #room-name {
  font-size: 24px;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  width: 300px;
  max-width: 90%;
  margin-bottom: 16px;
}

#name-form p {
  text-align: center;
  color: #666;
  max-width: 500px;
  line-height: 1.5;
}

#room-form button {
  font-size: 18px;
  padding: 12px 24px;
  margin: 8px;
  border: 2px solid #0078d4;
  background: #0078d4;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}

#room-form button:hover {
  background: #106ebe;
}

/* Mobile styles */
@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    z-index: 10;
    display: none;
  }
  
  #sidebar.active {
    display: flex;
  }
  
  #chat-area {
    display: none;
  }
  
  #chat-area.active {
    display: flex;
  }
  
  #mobile-toggle {
    position: fixed;
    bottom: 16px;
    right: 16px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #0078d4;
    color: white;
    border: none;
    font-size: 24px;
    z-index: 20;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }
  
  #mobile-toggle.active {
    display: flex;
  }
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

<!--===================================================================================-->
<!-- The actual HTML. There is not much of it. -->

  </head>
  <body>
    <div id="app-container">
      <!-- Sidebar -->
      <aside id="sidebar">
        <div id="room-search-container">
          <input type="text" id="room-search" placeholder="Search rooms...">
          <div id="room-results"></div>
        </div>
        <div id="sidebar-roster"></div>
      </aside>
      
      <!-- Main Chat Area -->
      <main id="chat-area">
        <div id="chatlog">
          <div id="spacer"></div>
        </div>
        <form id="chat-input-container" action="/fake-form-action">
          <input id="chat-input" autocomplete="off">
        </form>
      </main>
    </div>
    
    <!-- Mobile Toggle Button -->
    <button id="mobile-toggle" style="display: none;">☰</button>
    
    <!-- Forms -->
    <form id="name-form" action="/fake-form-action">
      <input id="name-input" placeholder="your name">
      <p>This chat runs entirely on the edge<br>
        <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">Durable Objects</a></p>
    </form>
    
    <form id="room-form" action="/fake-form-action">
      <p>Public Room:</p>
      <input id="room-name" placeholder="room name">
      <button id="go-public">Go &raquo;</button>
      <p>OR</p>
      <button id="go-private">Private Room &raquo;</button>
    </form>

  </body>

<!--===================================================================================-->
<!-- Client-side JavaScript code for the app. -->

<script type="text/javascript">
// Room History Manager
const RoomHistory = {
  addRoom(roomname) {
    let history = JSON.parse(localStorage.getItem('room-history') || '[]');
    if (!history.includes(roomname)) {
      history.push(roomname);
      localStorage.setItem('room-history', JSON.stringify(history));
    }
  },
  
  searchRooms(query) {
    let history = JSON.parse(localStorage.getItem('room-history') || '[]');
    return history.filter(room => 
      room.toLowerCase().includes(query.toLowerCase())
    );
  },
  
  getRecentRooms(limit = 10) {
    let history = JSON.parse(localStorage.getItem('room-history') || '[]');
    return history.slice(-limit);
  }
};

// UI State
let currentView = 'sidebar'; // 'sidebar' or 'chat'
let isMobile = window.innerWidth <= 768;

// DOM Elements
let currentWebSocket = null;
let nameForm = document.querySelector("#name-form");
let nameInput = document.querySelector("#name-input");
let roomForm = document.querySelector("#room-form");
let roomNameInput = document.querySelector("#room-name");
let goPublicButton = document.querySelector("#go-public");
let goPrivateButton = document.querySelector("#go-private");
let chatArea = document.querySelector("#chat-area");
let sidebar = document.querySelector("#sidebar");
let chatlog = document.querySelector("#chatlog");
let chatInput = document.querySelector("#chat-input");
let roster = document.querySelector("#sidebar-roster");
let mobileToggle = document.querySelector("#mobile-toggle");
let roomSearch = document.querySelector("#room-search");
let roomResults = document.querySelector("#room-results");

// Is the chatlog scrolled to the bottom?
let isAtBottom = true;

let username;
let roomname;

let hostname = window.location.host;
if (hostname == "") {
  hostname = "room.soeparnocorp.workers.dev";
}

let lastSeenTimestamp = 0;
let wroteWelcomeMessages = false;

// Initialize
function init() {
  setupResponsive();
  setupRoomSearch();
  startNameChooser();
}

// Responsive layout
function setupResponsive() {
  isMobile = window.innerWidth <= 768;
  
  if (isMobile) {
    mobileToggle.style.display = 'flex';
    showView('sidebar');
  } else {
    mobileToggle.style.display = 'none';
    sidebar.style.display = 'flex';
    chatArea.style.display = 'flex';
  }
  
  window.addEventListener('resize', setupResponsive);
}

// View management
function showView(view) {
  currentView = view;
  
  if (isMobile) {
    if (view === 'sidebar') {
      sidebar.classList.add('active');
      chatArea.classList.remove('active');
      mobileToggle.textContent = '☰';
    } else {
      sidebar.classList.remove('active');
      chatArea.classList.add('active');
      mobileToggle.textContent = '←';
    }
  }
}

// Room search
function setupRoomSearch() {
  // Show recent rooms initially
  updateRoomResults(RoomHistory.getRecentRooms(5));
  
  roomSearch.addEventListener('input', function(e) {
    let query = e.target.value.trim();
    
    if (query.length >= 2) {
      let results = RoomHistory.searchRooms(query);
      updateRoomResults(results);
    } else if (query.length === 0) {
      updateRoomResults(RoomHistory.getRecentRooms(5));
    }
  });
  
  roomSearch.addEventListener('focus', function() {
    updateRoomResults(RoomHistory.getRecentRooms(5));
  });
}

function updateRoomResults(rooms) {
  if (rooms.length === 0) {
    roomResults.innerHTML = '<div style="color: #999; font-style: italic; padding: 8px;">No rooms found</div>';
    return;
  }
  
  roomResults.innerHTML = rooms.map(room => `
    <div class="room-result" data-room="${room}">
      #${room}
    </div>
  `).join('');
  
  // Add click handlers
  roomResults.querySelectorAll('.room-result').forEach(item => {
    item.addEventListener('click', function() {
      let room = this.getAttribute('data-room');
      joinRoomFromSearch(room);
    });
  });
}

function joinRoomFromSearch(roomname) {
  if (roomForm.style.display !== 'none') {
    roomNameInput.value = roomname;
    goPublicButton.click();
  } else {
    // Already in chat, switch rooms
    location.hash = '#' + roomname;
    location.reload();
  }
}

// Mobile toggle
mobileToggle.addEventListener('click', function() {
  if (currentView === 'sidebar') {
    showView('chat');
  } else {
    showView('sidebar');
  }
});

// Original Cloudflare code (modified for new structure)
function startNameChooser() {
  nameForm.addEventListener("submit", event => {
    event.preventDefault();
    username = nameInput.value;
    if (username.length > 0) {
      startRoomChooser();
    }
  });

  nameInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 32) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 32);
    }
  });

  nameInput.focus();
}

function startRoomChooser() {
  nameForm.style.display = 'none';

  if (document.location.hash.length > 1) {
    roomname = document.location.hash.slice(1);
    startChat();
    return;
  }

  roomForm.addEventListener("submit", event => {
    event.preventDefault();
    roomname = roomNameInput.value;
    if (roomname.length > 0) {
      startChat();
    }
  });

  roomNameInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 32) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 32);
    }
  });

  goPublicButton.addEventListener("click", event => {
    roomname = roomNameInput.value;
    if (roomname.length > 0) {
      startChat();
    }
  });

  goPrivateButton.addEventListener("click", async event => {
    roomNameInput.disabled = true;
    goPublicButton.disabled = true;
    event.currentTarget.disabled = true;

    let response = await fetch("https://" + hostname + "/api/room", {method: "POST"});
    if (!response.ok) {
      alert("something went wrong");
      document.location.reload();
      return;
    }

    roomname = await response.text();
    startChat();
  });

  roomNameInput.focus();
}

function startChat() {
  roomForm.style.display = 'none';
  
  // Add to room history
  RoomHistory.addRoom(roomname);

  // Normalize the room name a bit.
  roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

  if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
    addChatMessage("ERROR", "Invalid room name.");
    return;
  }

  document.location.hash = "#" + roomname;

  chatInput.addEventListener("keydown", event => {
    if (event.keyCode == 38) {
      // up arrow
      chatlog.scrollBy(0, -50);
    } else if (event.keyCode == 40) {
      // down arrow
      chatlog.scrollBy(0, 50);
    } else if (event.keyCode == 33) {
      // page up
      chatlog.scrollBy(0, -chatlog.clientHeight + 50);
    } else if (event.keyCode == 34) {
      // page down
      chatlog.scrollBy(0, chatlog.clientHeight - 50);
    }
  });

  document.getElementById("chat-input-container").addEventListener("submit", event => {
    event.preventDefault();

    if (currentWebSocket) {
      currentWebSocket.send(JSON.stringify({message: chatInput.value}));
      chatInput.value = "";

      // Scroll to bottom whenever sending a message.
      chatlog.scrollBy(0, 1e8);
    }
  });

  chatInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 256) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 256);
    }
  });

  chatlog.addEventListener("scroll", event => {
    isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
  });

  chatInput.focus();
  
  document.getElementById("chat-area").addEventListener("click", event => {
    if (window.getSelection().toString() == "") {
      chatInput.focus();
    }
  });

  // Detect mobile keyboard appearing and disappearing, and adjust the scroll as appropriate.
  if('visualViewport' in window) {
    window.visualViewport.addEventListener('resize', function(event) {
      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    });
  }

  // On mobile, switch to chat view
  if (isMobile) {
    showView('chat');
  }

  join();
}

function join() {
  const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
  let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
  let rejoined = false;
  let startTime = Date.now();

  let rejoin = async () => {
    if (!rejoined) {
      rejoined = true;
      currentWebSocket = null;

      // Clear the roster.
      while (roster.firstChild) {
        roster.removeChild(roster.firstChild);
      }

      // Don't try to reconnect too rapidly.
      let timeSinceLastJoin = Date.now() - startTime;
      if (timeSinceLastJoin < 10000) {
        await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
      }

      // OK, reconnect now!
      join();
    }
  }

  ws.addEventListener("open", event => {
    currentWebSocket = ws;
    ws.send(JSON.stringify({name: username}));
  });

  ws.addEventListener("message", event => {
    let data = JSON.parse(event.data);

    if (data.error) {
      addChatMessage(null, "* Error: " + data.error);
    } else if (data.joined) {
      let p = document.createElement("p");
      p.innerText = data.joined;
      roster.appendChild(p);
    } else if (data.quit) {
      for (let child of roster.childNodes) {
        if (child.innerText == data.quit) {
          roster.removeChild(child);
          break;
        }
      }
    } else if (data.ready) {
      if (!wroteWelcomeMessages) {
        wroteWelcomeMessages = true;
        addChatMessage(null,
            "* This is a demo app built with Cloudflare Workers Durable Objects. The source code " +
            "can be found at: https://github.com/cloudflare/workers-chat-demo");
        addChatMessage(null,
            "* WARNING: Participants in this chat are random people on the internet. " +
            "Names are not authenticated; anyone can pretend to be anyone. The people " +
            "you are chatting with are NOT Cloudflare employees. Chat history is saved.");
        if (roomname.length == 64) {
          addChatMessage(null,
              "* This is a private room. You can invite someone to the room by sending them the URL.");
        } else {
          addChatMessage(null,
              "* Welcome to #" + roomname + ". Say hi!");
        }
      }
    } else {
      if (data.timestamp > lastSeenTimestamp) {
        addChatMessage(data.name, data.message);
        lastSeenTimestamp = data.timestamp;
      }
    }
  });

  ws.addEventListener("close", event => {
    console.log("WebSocket closed, reconnecting:", event.code, event.reason);
    rejoin();
  });
  ws.addEventListener("error", event => {
    console.log("WebSocket error, reconnecting:", event);
    rejoin();
  });
}

function addChatMessage(name, text) {
  let p = document.createElement("p");
  if (name) {
    let tag = document.createElement("span");
    tag.className = "username";
    tag.innerText = name + ": ";
    p.appendChild(tag);
  }
  p.appendChild(document.createTextNode(text));

  chatlog.appendChild(p);
  if (isAtBottom) {
    chatlog.scrollBy(0, 1e8);
  }
}

// Initialize the app
init();
</script>
<!--===================================================================================-->
</html>
