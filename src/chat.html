<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style type="text/css">
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
        
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
          background: #f0f0f0;
          height: 100vh;
          overflow: hidden;
        }

        /* ===== SMARTPHONE STYLES (edge-chat-demo original flow) ===== */
        
        /* Forms - exactly like original */
        #name-form, #room-form {
          position: fixed;
          z-index: 3;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: white;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          padding: 20px;
        }

        #name-input, #room-name {
          width: 90%;
          max-width: 400px;
          padding: 16px;
          font-size: 18px;
          border: 2px solid #ddd;
          border-radius: 8px;
          margin-bottom: 20px;
          text-align: center;
        }

        #room-form button, #go-public, #go-private {
          width: 90%;
          max-width: 400px;
          padding: 16px;
          font-size: 18px;
          border: none;
          border-radius: 8px;
          background: #007aff;
          color: white;
          cursor: pointer;
          margin-bottom: 10px;
        }

        #go-private {
          background: #5856d6;
        }

        #room-form p {
          margin: 15px 0;
          color: #666;
          text-align: center;
        }

        /* Chat container */
        #chatroom {
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          display: flex;
          flex-direction: column;
          background: white;
        }

        /* Chat log */
        #chatlog {
          flex: 1;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          padding: 15px;
          padding-bottom: 70px;
        }

        /* Messages */
        #chatlog p {
          margin: 8px 0;
          padding: 12px 16px;
          border-radius: 18px;
          max-width: 85%;
          word-wrap: break-word;
          line-height: 1.4;
        }

        /* Incoming messages */
        #chatlog p:not(.system-message) {
          background: #f0f0f0;
          align-self: flex-start;
          margin-right: auto;
        }

        /* Username styling */
        #chatlog span.username {
          font-weight: bold;
          display: block;
          margin-bottom: 4px;
          color: #333;
        }

        /* System messages */
        .system-message {
          align-self: center;
          background: #e8f5e8;
          color: #2d682d;
          font-style: italic;
          text-align: center;
          font-size: 14px;
          max-width: 90%;
          margin: 12px auto !important;
        }

        /* Input area */
        #chat-input-container {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: white;
          border-top: 1px solid #ddd;
          padding: 10px;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        #chat-input {
          flex: 1;
          padding: 12px 16px;
          border: 1px solid #ddd;
          border-radius: 20px;
          font-size: 16px;
          outline: none;
          min-height: 44px;
          max-height: 100px;
          resize: none;
        }

        #send-button {
          width: 44px;
          height: 44px;
          border-radius: 50%;
          background: #007aff;
          color: white;
          border: none;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
        }

        #send-button:disabled {
          background: #ccc;
          cursor: not-allowed;
        }

        /* Header for smartphone chat */
        .chat-header-mobile {
          background: #007aff;
          color: white;
          padding: 15px;
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .back-button {
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          padding: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .chat-title {
          flex: 1;
          font-size: 18px;
          font-weight: 500;
        }

        /* Roster - hidden on mobile */
        #roster {
          display: none;
        }

        /* Spacer */
        #spacer {
          height: 20px;
        }

        /* ===== DESKTOP STYLES (WhatsApp Web positioning) ===== */
        @media (min-width: 1025px) {
          body {
            background: #0c1317;
            color: #e9edef;
          }
          
          /* Forms stay centered but with dark theme */
          #name-form, #room-form {
            background: #0c1317;
          }
          
          #name-input, #room-name {
            background: #2a3942;
            border: 1px solid #222d34;
            color: #e9edef;
          }
          
          #room-form p {
            color: #8696a0;
          }
          
          /* WhatsApp Web layout */
          #chatroom {
            flex-direction: row;
            background: #0c1317;
            max-width: 1600px;
            margin: 0 auto;
          }
          
          /* Sidebar (left) */
          #roster {
            display: block;
            width: 480px;
            min-width: 380px;
            background: #111b21;
            border-right: 1px solid #222d34;
            display: flex;
            flex-direction: column;
            height: 100%;
          }
          
          .sidebar-header {
            background: #202c33;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
          }
          
          .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00a884, #53bdeb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
          }
          
          .room-info {
            padding: 20px;
            border-bottom: 1px solid #222d34;
          }
          
          .online-users {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
          }
          
          .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #222d34;
          }
          
          /* Chat area (right) */
          #chatlog {
            flex: 1;
            background: #0c1317;
            padding: 20px;
            right: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2314222c' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
          }
          
          /* Desktop message bubbles */
          #chatlog p:not(.system-message) {
            background: #202c33;
            color: #e9edef;
            border-radius: 7.5px;
            border-top-left-radius: 0;
            max-width: 65%;
          }
          
          .system-message {
            background: rgba(134, 150, 160, 0.15);
            color: #8696a0;
          }
          
          #chatlog span.username {
            color: #e9edef;
          }
          
          /* Desktop input */
          #chat-input-container {
            background: #202c33;
            border-top: 1px solid #222d34;
          }
          
          #chat-input {
            background: #2a3942;
            border: 1px solid #222d34;
            color: #e9edef;
          }
          
          /* Hide mobile header on desktop */
          .chat-header-mobile {
            display: none;
          }
          
          /* Show desktop header */
          .chat-header-desktop {
            background: #202c33;
            padding: 10px 20px;
            border-bottom: 1px solid #222d34;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
        }

        /* ===== TABLET (mix) ===== */
        @media (min-width: 769px) and (max-width: 1024px) {
          /* Show simple roster on right */
          #roster {
            display: block;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            background: #f8f8f8;
            border-left: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
          }
          
          #chatlog {
            right: 200px;
          }
          
          .chat-header-mobile {
            display: none;
          }
        }

        /* Mobile-specific fixes */
        @media (max-width: 768px) {
          .chat-header-desktop {
            display: none;
          }
          
          #chatlog {
            padding-top: 60px; /* Space for mobile header */
          }
          
          /* Ensure input is above mobile keyboard */
          #chat-input-container {
            padding-bottom: max(10px, env(safe-area-inset-bottom));
          }
        }
    </style>
  </head>
  <body>
    <!-- Name Form -->
    <div id="name-form">
      <input type="text" id="name-input" placeholder="your name" autocomplete="off">
      <p style="text-align: center; color: #666; margin-top: 20px; padding: 0 20px;">
        This chat runs entirely on the edge with Durable Objects
      </p>
    </div>

    <!-- Room Form -->
    <div id="room-form" style="display: none;">
      <p>Public Room:</p>
      <input type="text" id="room-name" placeholder="room name" autocomplete="off">
      <button id="go-public">Go →</button>
      <p>OR</p>
      <button id="go-private">Private Room →</button>
    </div>

    <!-- Chat Room -->
    <div id="chatroom" style="display: none;">
      <!-- Mobile Header (back button like WhatsApp) -->
      <div class="chat-header-mobile">
        <button class="back-button" id="back-button-mobile">←</button>
        <div class="chat-title" id="mobile-room-title">Chat Room</div>
      </div>

      <!-- Desktop Header -->
      <div class="chat-header-desktop">
        <div>
          <h3 id="desktop-room-title">Chat Room</h3>
          <p id="connection-status">Connected</p>
        </div>
        <button id="leave-button-desktop" style="background: #ff3b30; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
          Leave Room
        </button>
      </div>

      <!-- Sidebar (Desktop only) -->
      <div id="roster">
        <div class="sidebar-header">
          <div class="user-avatar" id="desktop-user-avatar">U</div>
          <div>
            <div id="desktop-username">User</div>
            <div style="font-size: 12px; color: #8696a0;">Online</div>
          </div>
        </div>
        
        <div class="room-info">
          <h4>Room: <span id="desktop-room-name">General</span></h4>
          <div style="font-size: 12px; color: #8696a0; margin-top: 5px;">
            <span id="online-count">1</span> users online
          </div>
        </div>
        
        <div class="online-users">
          <h4>Online Users</h4>
          <div id="user-list"></div>
        </div>
        
        <div class="sidebar-footer">
          <button id="leave-button-sidebar" style="width: 100%; padding: 12px; background: #ff3b30; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Leave Room
          </button>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chatlog">
        <div id="spacer"></div>
      </div>

      <!-- Input Area -->
      <div id="chat-input-container">
        <textarea id="chat-input" placeholder="Type your message..." disabled></textarea>
        <button id="send-button" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>

    <script>
        // ============================================
        // ORIGINAL EDGE-CHAT-DEMO CODE (preserved)
        // ============================================
        let currentWebSocket = null;
        let nameForm = document.querySelector("#name-form");
        let nameInput = document.querySelector("#name-input");
        let roomForm = document.querySelector("#room-form");
        let roomNameInput = document.querySelector("#room-name");
        let goPublicButton = document.querySelector("#go-public");
        let goPrivateButton = document.querySelector("#go-private");
        let chatroom = document.querySelector("#chatroom");
        let chatlog = document.querySelector("#chatlog");
        let chatInput = document.querySelector("#chat-input");
        let sendButton = document.querySelector("#send-button");
        let roster = document.querySelector("#roster");
        let userList = document.querySelector("#user-list");

        let isAtBottom = true;
        let username;
        let roomname;
        let hostname = window.location.host;
        if (hostname == "") {
          hostname = "localhost:8787";
        }

        // Mobile elements
        let backButtonMobile = document.querySelector("#back-button-mobile");
        let mobileRoomTitle = document.querySelector("#mobile-room-title");
        let leaveButtonDesktop = document.querySelector("#leave-button-desktop");
        let leaveButtonSidebar = document.querySelector("#leave-button-sidebar");
        let desktopRoomTitle = document.querySelector("#desktop-room-title");
        let desktopRoomName = document.querySelector("#desktop-room-name");
        let desktopUserAvatar = document.querySelector("#desktop-user-avatar");
        let desktopUsername = document.querySelector("#desktop-username");
        let onlineCount = document.querySelector("#online-count");

        // Initialize
        function startNameChooser() {
          nameForm.addEventListener("submit", event => {
            event.preventDefault();
            username = nameInput.value;
            if (username.length > 0) {
              startRoomChooser();
            }
          });

          nameInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 32);
            }
          });

          nameInput.focus();
        }

        function startRoomChooser() {
          nameForm.style.display = "none";

          if (document.location.hash.length > 1) {
            roomname = document.location.hash.slice(1);
            startChat();
            return;
          }

          roomForm.style.display = "flex";

          roomForm.addEventListener("submit", event => {
            event.preventDefault();
            roomname = roomNameInput.value;
            if (roomname.length > 0) {
              startChat();
            }
          });

          roomNameInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 32);
            }
          });

          goPublicButton.addEventListener("click", event => {
            roomname = roomNameInput.value;
            if (roomname.length > 0) {
              startChat();
            }
          });

          goPrivateButton.addEventListener("click", async event => {
            roomNameInput.disabled = true;
            goPublicButton.disabled = true;
            event.currentTarget.disabled = true;

            let response = await fetch("https://" + hostname + "/api/room", {method: "POST"});
            if (!response.ok) {
              alert("something went wrong");
              document.location.reload();
              return;
            }

            roomname = await response.text();
            startChat();
          });

          roomNameInput.focus();
        }

        function startChat() {
          roomForm.style.display = "none";

          // Normalize the room name a bit.
          roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

          if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
            addChatMessage("ERROR", "Invalid room name.");
            return;
          }

          document.location.hash = "#" + roomname;

          // Set room titles
          mobileRoomTitle.textContent = roomname;
          desktopRoomTitle.textContent = roomname;
          desktopRoomName.textContent = roomname;
          desktopUserAvatar.textContent = username.charAt(0).toUpperCase();
          desktopUsername.textContent = username;

          // Setup event listeners
          chatInput.addEventListener("input", event => {
            if (event.currentTarget.value.length > 256) {
              event.currentTarget.value = event.currentTarget.value.slice(0, 256);
            }
            sendButton.disabled = chatInput.value.trim().length === 0;
          });

          chatroom.addEventListener("submit", event => {
            event.preventDefault();
            if (currentWebSocket) {
              currentWebSocket.send(JSON.stringify({message: chatInput.value}));
              chatInput.value = "";
              sendButton.disabled = true;
              chatlog.scrollBy(0, 1e8);
            }
          });

          chatlog.addEventListener("scroll", event => {
            isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
          });

          // Mobile back button (acts as exit)
          backButtonMobile.addEventListener("click", leaveRoom);
          leaveButtonDesktop.addEventListener("click", leaveRoom);
          leaveButtonSidebar.addEventListener("click", leaveRoom);

          chatInput.disabled = false;
          chatroom.style.display = "flex";
          chatInput.focus();

          // Mobile keyboard resize handling
          if('visualViewport' in window) {
            window.visualViewport.addEventListener('resize', function(event) {
              if (isAtBottom) {
                chatlog.scrollBy(0, 1e8);
              }
            });
          }

          join();
        }

        function leaveRoom() {
          if (currentWebSocket) {
            currentWebSocket.close();
            currentWebSocket = null;
          }
          
          chatroom.style.display = "none";
          nameForm.style.display = "flex";
          roomForm.style.display = "none";
          nameInput.value = "";
          roomNameInput.value = "";
          chatInput.value = "";
          chatlog.innerHTML = '<div id="spacer"></div>';
          userList.innerHTML = "";
          
          document.location.hash = "";
          nameInput.focus();
        }

        let lastSeenTimestamp = 0;
        let wroteWelcomeMessages = false;

        function join() {
          const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
          let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
          let rejoined = false;
          let startTime = Date.now();

          let rejoin = async () => {
            if (!rejoined) {
              rejoined = true;
              currentWebSocket = null;

              while (userList.firstChild) {
                userList.removeChild(userList.firstChild);
              }

              let timeSinceLastJoin = Date.now() - startTime;
              if (timeSinceLastJoin < 10000) {
                await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
              }

              join();
            }
          }

          ws.addEventListener("open", event => {
            currentWebSocket = ws;
            ws.send(JSON.stringify({name: username}));
          });

          ws.addEventListener("message", event => {
            let data = JSON.parse(event.data);

            if (data.error) {
              addChatMessage(null, "* Error: " + data.error);
            } else if (data.joined) {
              let p = document.createElement("p");
              p.innerText = data.joined;
              userList.appendChild(p);
              updateOnlineCount();
            } else if (data.quit) {
              for (let child of userList.childNodes) {
                if (child.innerText == data.quit) {
                  userList.removeChild(child);
                  break;
                }
              }
              updateOnlineCount();
            } else if (data.ready) {
              if (!wroteWelcomeMessages) {
                wroteWelcomeMessages = true;
                addChatMessage(null,
                    "* This is a demo app built with Durable Objects.");
                addChatMessage(null,
                    "* WARNING: Participants in this chat are random people on the internet. " +
                    "Names are not authenticated. Chat history is saved.");
                if (roomname.length == 64) {
                  addChatMessage(null,
                      "* This is a private room. You can invite someone by sending them the URL.");
                } else {
                  addChatMessage(null,
                      "* Welcome to #" + roomname + ". Say hi!");
                }
              }
            } else {
              if (data.timestamp > lastSeenTimestamp) {
                addChatMessage(data.name, data.message);
                lastSeenTimestamp = data.timestamp;
              }
            }
          });

          ws.addEventListener("close", event => {
            console.log("WebSocket closed, reconnecting:", event.code, event.reason);
            rejoin();
          });
          ws.addEventListener("error", event => {
            console.log("WebSocket error, reconnecting:", event);
            rejoin();
          });
        }

        function addChatMessage(name, text) {
          let p = document.createElement("p");
          if (name) {
            let tag = document.createElement("span");
            tag.className = "username";
            tag.innerText = name + ": ";
            p.appendChild(tag);
          }
          p.appendChild(document.createTextNode(text));

          if (text.includes("joined") || text.includes("left") || text.includes("Welcome") || text.includes("WARNING") || text.includes("Error")) {
            p.className = "system-message";
          }

          chatlog.appendChild(p);
          if (isAtBottom) {
            chatlog.scrollBy(0, 1e8);
          }
        }

        function updateOnlineCount() {
          let count = userList.childNodes.length + 1;
          onlineCount.textContent = count;
        }

        // Start the app
        startNameChooser();
    </script>
  </body>
</html>
