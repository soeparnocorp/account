<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style type="text/css">
    * { box-sizing: border-box; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
    }

    #chatlog {
      position: fixed;
      top: 0;
      bottom: 32px;
      left: 0;
      right: 200px;
      overflow-y: auto;
      padding: 8px;
      overflow-wrap: break-word;
    }
    #chatlog span.username { font-weight: bold; }
    #spacer { height: calc(100vh - 32px - 5em); }
    #roster {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 32px;
      width: 200px;
      font-weight: bold;
      padding: 8px;
      border-left: none;
    }
    p {
      margin-top: 0;
      margin-bottom: 8px;
    }
    p:last-of-type { margin: 0; }
    ::-webkit-scrollbar { display: none; }

    @media(max-width:600px) {
      #roster { display: none; }
      #chatlog { right: 0; }
    }

    #chat-input {
      position: fixed;
      width: 100%;
      height: 32px;
      bottom: 0;
      left: 0;
      border: none;
      border-top: none;
      padding-left: 32px;
      outline: none;
    }
    #chatroom::before {
      z-index: 1;
      display: block;
      content: ">";
      position: fixed;
      bottom: 0;
      left: 0;
      width: 32px;
      height: 32px;
      line-height: 32px;
      text-align: center;
      font-weight: bold;
      color: #888;
      -webkit-text-stroke-width: 2px;
    }

    #name-form {
      position: fixed;
      z-index: 3;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
    }
    #name-input {
      position: fixed;
      font-size: 200%;
      top: calc(50% - 1em);
      left: calc(50% - 8em);
      width: 16em;
      height: 2em;
      margin: 0;
      text-align: center;
      border: 1px solid #bbb;
    }
    #name-form p {
      position: fixed;
      top: calc(50% + 3em);
      width: 100%;
      text-align: center;
    }

    #room-form {
      position: fixed;
      z-index: 2;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
      font-size: 200%;
      margin-top: calc(50vh - 3em);
      text-align: center;
    }
    #room-name {
      font-size: inherit;
      border: 1px solid #bbb;
      height: 2em;
      width: 16em;
      padding-left: 1em;
    }
    #room-form button {
      font-size: inherit;
      border: 1px solid #bbb;
      background-color: #eee;
      height: 2em;
    }
    #go-public { width: 8em; }

    @media(max-width:660px) {
      #name-input, #room-form { font-size: 150%; }
      #name-form p { font-size: 75%; }
    }
    @media(max-width:500px) {
      #name-input, #room-form { font-size: 100%; }
      #name-form p { font-size: 50%; }
    }
  </style>
</head>
<body>
  <!-- FORM 1: Your Name -->
  <form id="name-form" action="/fake-form-action">
    <input id="name-input" placeholder="your name">
    <p>This chat runs entirely on the edge<br>
      <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">Durable Objects</a>
    </p>
  </form>

  <!-- FORM 2: Public Room Only (Private Room Dihapus) -->
  <form id="room-form" action="/fake-form-action">
    <p>Enter Room Name:</p>
    <input id="room-name" placeholder="room name">
    <button id="go-public">Go &raquo;</button>
    <!-- TOMBOL PRIVATE ROOM DIHAPUS -->
  </form>

  <!-- CHAT ROOM -->
  <form id="chatroom" action="/fake-form-action">
    <div id="chatlog">
      <div id="spacer"></div>
    </div>
    <div id="roster"></div>
    <input id="chat-input">
  </form>

  <script type="text/javascript">
    let currentWebSocket = null;

    const nameForm = document.querySelector("#name-form");
    const nameInput = document.querySelector("#name-input");
    const roomForm = document.querySelector("#room-form");
    const roomNameInput = document.querySelector("#room-name");
    const goPublicButton = document.querySelector("#go-public");
    const chatroom = document.querySelector("#chatroom");
    const chatlog = document.querySelector("#chatlog");
    const chatInput = document.querySelector("#chat-input");
    const roster = document.querySelector("#roster");

    let isAtBottom = true;
    let username;
    let roomname;

    let hostname = window.location.host;
    if (hostname == "") {
      hostname = "localhost:8787"; // Default for local dev
    }

    // ===== NAME FORM =====
    function startNameChooser() {
      nameForm.addEventListener("submit", event => {
        event.preventDefault();
        username = nameInput.value.trim();
        if (username.length > 0) {
          startRoomChooser();
        }
      });

      nameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });

      nameInput.focus();
    }

    // ===== ROOM FORM (PUBLIC ONLY) =====
    function startRoomChooser() {
      nameForm.remove();

      // Cek apakah ada hash di URL (misalnya dari bookmark)
      if (document.location.hash.length > 1) {
        roomname = document.location.hash.slice(1);
        startChat();
        return;
      }

      roomForm.addEventListener("submit", event => {
        event.preventDefault();
        roomname = roomNameInput.value.trim();
        if (roomname.length > 0) {
          startChat();
        }
      });

      roomNameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });

      goPublicButton.addEventListener("click", event => {
        roomname = roomNameInput.value.trim();
        if (roomname.length > 0) {
          startChat();
        }
      });

      roomNameInput.focus();
    }

    // ===== CHAT ROOM =====
    function startChat() {
      roomForm.remove();

      // Normalize room name
      roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

      // ðŸ”´ CEK HANYA UNTUK PUBLIC ROOM (max 32 chars)
      if (roomname.length > 32) {
        addChatMessage("ERROR", "Invalid room name (max 32 characters).");
        return;
      }

      document.location.hash = "#" + roomname;

      // Setup event listeners
      chatInput.addEventListener("keydown", event => {
        if (event.keyCode == 38) chatlog.scrollBy(0, -50);
        else if (event.keyCode == 40) chatlog.scrollBy(0, 50);
        else if (event.keyCode == 33) chatlog.scrollBy(0, -chatlog.clientHeight + 50);
        else if (event.keyCode == 34) chatlog.scrollBy(0, chatlog.clientHeight - 50);
      });

      chatroom.addEventListener("submit", event => {
        event.preventDefault();
        if (currentWebSocket && chatInput.value.trim()) {
          currentWebSocket.send(JSON.stringify({message: chatInput.value}));
          chatInput.value = "";
          chatlog.scrollBy(0, 1e8);
        }
      });

      chatInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 256) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 256);
        }
      });

      chatlog.addEventListener("scroll", () => {
        isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
      });

      chatInput.focus();
      
      document.body.addEventListener("click", event => {
        if (window.getSelection().toString() == "") {
          chatInput.focus();
        }
      });

      if ('visualViewport' in window) {
        window.visualViewport.addEventListener('resize', () => {
          if (isAtBottom) chatlog.scrollBy(0, 1e8);
        });
      }

      join();
    }

    let lastSeenTimestamp = 0;
    let wroteWelcomeMessages = false;

    // ===== WEBSOCKET =====
    function join() {
      const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
      let ws = new WebSocket(`${wss}${hostname}/api/room/${roomname}/websocket`);
      let rejoined = false;
      let startTime = Date.now();

      const rejoin = async () => {
        if (!rejoined) {
          rejoined = true;
          currentWebSocket = null;

          while (roster.firstChild) {
            roster.removeChild(roster.firstChild);
          }

          let timeSinceLastJoin = Date.now() - startTime;
          if (timeSinceLastJoin < 10000) {
            await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
          }

          join();
        }
      };

      ws.addEventListener("open", () => {
        currentWebSocket = ws;
        ws.send(JSON.stringify({name: username}));
      });

      ws.addEventListener("message", event => {
        let data = JSON.parse(event.data);

        if (data.error) {
          addChatMessage(null, "* Error: " + data.error);
        } else if (data.joined) {
          let p = document.createElement("p");
          p.innerText = data.joined;
          roster.appendChild(p);
        } else if (data.quit) {
          for (let child of roster.childNodes) {
            if (child.innerText == data.quit) {
              roster.removeChild(child);
              break;
            }
          }
        } else if (data.ready) {
          if (!wroteWelcomeMessages) {
            wroteWelcomeMessages = true;
            addChatMessage(null, "* Welcome to #" + roomname + ". Say hi!");
          }
        } else {
          if (data.timestamp > lastSeenTimestamp) {
            addChatMessage(data.name, data.message);
            lastSeenTimestamp = data.timestamp;
          }
        }
      });

      ws.addEventListener("close", () => {
        console.log("WebSocket closed, reconnecting");
        rejoin();
      });
      
      ws.addEventListener("error", () => {
        console.log("WebSocket error, reconnecting");
        rejoin();
      });
    }

    function addChatMessage(name, text) {
      let p = document.createElement("p");
      if (name) {
        let tag = document.createElement("span");
        tag.className = "username";
        tag.innerText = name + ": ";
        p.appendChild(tag);
      }
      p.appendChild(document.createTextNode(text));

      chatlog.appendChild(p);
      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    }

    // Start the app
    startNameChooser();
  </script>
</body>
</html>
