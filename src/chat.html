<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f0f2f5; }

    /* Layout */
    .app {
      display: grid;
      grid-template-columns: 320px 1fr;
      height: 100vh;
      background:#eaeef3;
    }
    @media(max-width: 720px){
      .app { grid-template-columns: 1fr; }
      .sidebar { display:none; }
    }

    /* Sidebar */
    .sidebar {
      background:#ffffff;
      border-right:1px solid #ddd;
      display:flex;
      flex-direction:column;
    }
    .sidebar-header {
      padding:10px;
      border-bottom:1px solid #ddd;
      font-weight:bold;
    }
    .sidebar-body {
      flex:1;
      overflow:auto;
      padding:8px;
    }

    /* Chat panel */
    .chat {
      display:flex;
      flex-direction:column;
      background:#efeae2;
    }
    .chat-header {
      background:#ffffff;
      border-bottom:1px solid #ddd;
      padding:10px;
      font-weight:bold;
    }
    #chatlog {
      flex:1;
      overflow-y:auto;
      padding:10px;
      overflow-wrap: break-word;
    }
    #chatlog p { margin:0 0 8px 0; }
    #chatlog span.username { font-weight:bold; }

    .chat-input-wrap {
      background:#ffffff;
      border-top:1px solid #ddd;
      padding:6px;
    }
    #chat-input {
      width:100%;
      height:36px;
      border-radius:18px;
      border:1px solid #ccc;
      padding:0 12px;
      outline:none;
    }

    /* Overlay forms */
    .overlay {
      position:fixed;
      inset:0;
      background:#ffffff;
      z-index:5;
      display:flex;
      flex-direction:column;
    }
    .overlay-header {
      padding:12px;
      border-bottom:1px solid #ddd;
      font-weight:bold;
    }
    .overlay-body {
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .overlay input, .overlay button {
      height:40px;
      font-size:16px;
      padding:0 10px;
    }

    ::-webkit-scrollbar { display:none; }
  </style>
</head>

<body>
<div class="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">Rooms / Roster</div>
    <div id="roster" class="sidebar-body"></div>
  </div>

  <!-- Chat -->
  <div class="chat">
    <div class="chat-header" id="chat-title">Chat</div>
    <form id="chatroom">
      <div id="chatlog"><div id="spacer"></div></div>
      <div class="chat-input-wrap">
        <input id="chat-input" placeholder="Type a message">
      </div>
    </form>
  </div>
</div>

<!-- Name Overlay -->
<form id="name-form" class="overlay">
  <div class="overlay-header">Your Name</div>
  <div class="overlay-body">
    <input id="name-input" placeholder="your name">
    <p>This chat runs entirely on the edge (Durable Objects)</p>
  </div>
</form>

<!-- Room Overlay -->
<form id="room-form" class="overlay">
  <div class="overlay-header">Join / Create Room</div>
  <div class="overlay-body">
    <input id="room-name" placeholder="room name">
    <button id="go-public">Go Public</button>
    <button id="go-private">Create Private Room</button>
  </div>
</form>

<script type="text/javascript">
/* ===== ORIGINAL FLOW PRESERVED ===== */
let currentWebSocket = null;

let nameForm = document.querySelector("#name-form");
let nameInput = document.querySelector("#name-input");
let roomForm = document.querySelector("#room-form");
let roomNameInput = document.querySelector("#room-name");
let goPublicButton = document.querySelector("#go-public");
let goPrivateButton = document.querySelector("#go-private");
let chatroom = document.querySelector("#chatroom");
let chatlog = document.querySelector("#chatlog");
let chatInput = document.querySelector("#chat-input");
let roster = document.querySelector("#roster");
let chatTitle = document.querySelector("#chat-title");

let isAtBottom = true;
let username;
let roomname;

let hostname = window.location.host || "room.soeparnocorp.workers.dev";

function startNameChooser() {
  nameForm.addEventListener("submit", e => {
    e.preventDefault();
    username = nameInput.value;
    if (username.length > 0) startRoomChooser();
  });
  nameInput.focus();
}

function startRoomChooser() {
  nameForm.remove();

  if (document.location.hash.length > 1) {
    roomname = document.location.hash.slice(1);
    startChat();
    return;
  }

  roomForm.addEventListener("submit", e => {
    e.preventDefault();
    roomname = roomNameInput.value;
    if (roomname.length > 0) startChat();
  });

  goPublicButton.addEventListener("click", e => {
    e.preventDefault();
    roomname = roomNameInput.value;
    if (roomname.length > 0) startChat();
  });

  goPrivateButton.addEventListener("click", async e => {
    e.preventDefault();
    let res = await fetch("https://" + hostname + "/api/room", {method:"POST"});
    if (!res.ok) return location.reload();
    roomname = await res.text();
    startChat();
  });

  roomNameInput.focus();
}

function startChat() {
  roomForm.remove();

  roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();
  document.location.hash = "#" + roomname;
  chatTitle.textContent = "#" + roomname;

  chatroom.addEventListener("submit", e => {
    e.preventDefault();
    if (currentWebSocket) {
      currentWebSocket.send(JSON.stringify({message: chatInput.value}));
      chatInput.value = "";
      chatlog.scrollBy(0, 1e8);
    }
  });

  chatlog.addEventListener("scroll", () => {
    isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
  });

  chatInput.focus();
  join();
}

let lastSeenTimestamp = 0;

function join() {
  const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
  let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");

  ws.addEventListener("open", () => {
    currentWebSocket = ws;
    ws.send(JSON.stringify({name: username}));
  });

  ws.addEventListener("message", e => {
    let data = JSON.parse(e.data);
    if (data.joined) {
      let p = document.createElement("p");
      p.innerText = data.joined;
      roster.appendChild(p);
    } else if (data.quit) {
      for (let c of roster.childNodes) if (c.innerText === data.quit) roster.removeChild(c);
    } else if (!data.error && data.timestamp > lastSeenTimestamp) {
      addChatMessage(data.name, data.message);
      lastSeenTimestamp = data.timestamp;
    }
  });

  ws.addEventListener("close", () => join());
  ws.addEventListener("error", () => join());
}

function addChatMessage(name, text) {
  let p = document.createElement("p");
  if (name) {
    let s = document.createElement("span");
    s.className = "username";
    s.innerText = name + ": ";
    p.appendChild(s);
  }
  p.appendChild(document.createTextNode(text));
  chatlog.appendChild(p);
  if (isAtBottom) chatlog.scrollBy(0, 1e8);
}

startNameChooser();
</script>
</body>
</html>
