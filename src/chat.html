<!DOCTYPE html>
<!--
  WhatsApp Web-style positioning for PC
  Modified from original Cloudflare Chat Demo
-->

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style type="text/css">
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
        
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
          background: #0c1317;
          color: #e9edef;
          height: 100vh;
          overflow: hidden;
        }

        /* WhatsApp Web Container */
        .whatsapp-container {
          display: flex;
          height: 100vh;
          max-width: 1600px;
          margin: 0 auto;
          background: #0c1317;
        }

        /* Left Sidebar - Contact List (like WhatsApp) */
        .sidebar {
          width: 480px;
          min-width: 380px;
          background: #111b21;
          border-right: 1px solid #222d34;
          display: flex;
          flex-direction: column;
          height: 100%;
        }

        /* Sidebar Header */
        .sidebar-header {
          background: #202c33;
          padding: 10px 16px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          height: 60px;
          border-bottom: 1px solid #222d34;
        }

        .user-profile {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .profile-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: linear-gradient(135deg, #00a884, #53bdeb);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: white;
          font-size: 18px;
        }

        .profile-name {
          font-weight: 500;
          font-size: 16px;
        }

        .sidebar-actions {
          display: flex;
          gap: 20px;
          color: #aebac1;
        }

        .sidebar-actions i {
          font-size: 20px;
          cursor: pointer;
        }

        /* Search Bar */
        .search-container {
          padding: 10px 16px;
          background: #111b21;
        }

        .search-box {
          background: #202c33;
          border-radius: 8px;
          padding: 10px 16px;
          display: flex;
          align-items: center;
          gap: 10px;
          color: #8696a0;
        }

        .search-box i {
          font-size: 16px;
        }

        .search-box input {
          background: transparent;
          border: none;
          color: #e9edef;
          font-size: 14px;
          width: 100%;
          outline: none;
        }

        /* Contact List */
        .contact-list {
          flex: 1;
          overflow-y: auto;
          background: #111b21;
        }

        .contact-item {
          display: flex;
          align-items: center;
          padding: 12px 16px;
          gap: 15px;
          cursor: pointer;
          border-bottom: 1px solid #222d34;
          transition: background 0.2s;
        }

        .contact-item:hover {
          background: #202c33;
        }

        .contact-item.active {
          background: #2a3942;
        }

        .contact-avatar {
          width: 49px;
          height: 49px;
          border-radius: 50%;
          background: linear-gradient(135deg, #00a884, #53bdeb);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: white;
          font-size: 18px;
        }

        .contact-info {
          flex: 1;
          min-width: 0;
        }

        .contact-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 4px;
        }

        .contact-name {
          font-weight: 500;
          font-size: 16px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .contact-time {
          font-size: 12px;
          color: #8696a0;
        }

        .contact-preview {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .contact-message {
          font-size: 14px;
          color: #8696a0;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          flex: 1;
        }

        .unread-badge {
          background: #00a884;
          color: white;
          font-size: 12px;
          font-weight: 500;
          padding: 2px 6px;
          border-radius: 10px;
          min-width: 20px;
          text-align: center;
        }

        /* Main Chat Area */
        .chat-main {
          flex: 1;
          display: flex;
          flex-direction: column;
          height: 100%;
          position: relative;
        }

        /* Chat Header */
        .chat-header {
          background: #202c33;
          padding: 10px 16px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          height: 60px;
          border-bottom: 1px solid #222d34;
        }

        .chat-partner {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .partner-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: linear-gradient(135deg, #00a884, #53bdeb);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: white;
          font-size: 18px;
        }

        .partner-info h3 {
          font-weight: 500;
          font-size: 16px;
          margin-bottom: 2px;
        }

        .partner-info p {
          font-size: 13px;
          color: #8696a0;
        }

        .chat-actions {
          display: flex;
          gap: 20px;
          color: #aebac1;
        }

        .chat-actions i {
          font-size: 20px;
          cursor: pointer;
        }

        /* Messages Container */
        .messages-container {
          flex: 1;
          background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2314222c' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
          background-color: #0c1317;
          padding: 20px;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
        }

        /* Message Bubbles */
        .message {
          max-width: 65%;
          margin-bottom: 10px;
          display: flex;
          animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .message.incoming {
          align-self: flex-start;
        }

        .message.outgoing {
          align-self: flex-end;
          flex-direction: row-reverse;
        }

        .message-avatar {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          margin-top: 4px;
          margin-right: 8px;
          background: linear-gradient(135deg, #00a884, #53bdeb);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          font-weight: bold;
          color: white;
          flex-shrink: 0;
        }

        .message.outgoing .message-avatar {
          margin-right: 0;
          margin-left: 8px;
        }

        .message-content {
          position: relative;
        }

        .message-bubble {
          padding: 8px 12px;
          border-radius: 7.5px;
          font-size: 14px;
          line-height: 1.4;
          word-wrap: break-word;
          max-width: 100%;
          box-shadow: 0 1px 0.5px rgba(11, 20, 26, 0.13);
        }

        .message.incoming .message-bubble {
          background: #202c33;
          border-top-left-radius: 0;
        }

        .message.outgoing .message-bubble {
          background: #005c4b;
          border-top-right-radius: 0;
          color: #e9edef;
        }

        .message-info {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          gap: 4px;
          margin-top: 4px;
          font-size: 11px;
          color: #ffffff99;
        }

        .message.incoming .message-info {
          justify-content: flex-start;
          color: #8696a0;
        }

        .message-time {
          font-size: 11px;
        }

        .message-status {
          font-size: 13px;
        }

        /* System Messages */
        .system-message {
          align-self: center;
          background: rgba(134, 150, 160, 0.15);
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 12.5px;
          color: #8696a0;
          margin: 10px 0;
          max-width: 80%;
          text-align: center;
        }

        /* Input Area */
        .input-container {
          background: #202c33;
          padding: 10px 16px;
          display: flex;
          align-items: center;
          gap: 10px;
          min-height: 62px;
        }

        .input-actions {
          display: flex;
          gap: 15px;
          color: #8696a0;
        }

        .input-actions i {
          font-size: 24px;
          cursor: pointer;
        }

        .message-input {
          flex: 1;
          background: #2a3942;
          border: none;
          border-radius: 8px;
          padding: 10px 16px;
          color: #e9edef;
          font-size: 15px;
          outline: none;
          resize: none;
          max-height: 100px;
          min-height: 40px;
          line-height: 1.4;
          font-family: inherit;
        }

        .message-input::placeholder {
          color: #8696a0;
        }

        .send-button {
          background: #00a884;
          border: none;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          color: white;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background 0.2s;
        }

        .send-button:hover {
          background: #06cf9c;
        }

        .send-button i {
          font-size: 18px;
        }

        .send-button:disabled {
          background: #2a3942;
          color: #8696a0;
          cursor: not-allowed;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
          width: 6px;
        }

        ::-webkit-scrollbar-track {
          background: transparent;
        }

        ::-webkit-scrollbar-thumb {
          background: #374045;
          border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: #4a5c65;
        }

        /* Typing Indicator */
        .typing-indicator {
          padding: 8px 16px;
          background: #202c33;
          border-radius: 8px;
          align-self: flex-start;
          margin-bottom: 10px;
          display: none;
        }

        .typing-indicator.active {
          display: block;
          animation: fadeIn 0.3s;
        }

        .typing-dots {
          display: flex;
          gap: 4px;
        }

        .typing-dots span {
          width: 8px;
          height: 8px;
          background: #8696a0;
          border-radius: 50%;
          animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
          animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
          animation-delay: 0.4s;
        }

        @keyframes typing {
          0%, 60%, 100% { transform: translateY(0); }
          30% { transform: translateY(-4px); }
        }

        /* Date Separator */
        .date-separator {
          align-self: center;
          background: #1e2b32;
          padding: 6px 12px;
          border-radius: 8px;
          font-size: 12.5px;
          color: #8696a0;
          margin: 15px 0;
        }

        /* Welcome Screen */
        .welcome-screen {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          text-align: center;
          padding: 40px;
          background: #0c1317;
        }

        .welcome-icon {
          width: 200px;
          height: 200px;
          background: linear-gradient(135deg, #00a884, #53bdeb);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 30px;
        }

        .welcome-icon i {
          font-size: 80px;
          color: white;
        }

        .welcome-text h1 {
          font-size: 32px;
          font-weight: 300;
          margin-bottom: 15px;
          color: #e9edef;
        }

        .welcome-text p {
          font-size: 14px;
          color: #8696a0;
          line-height: 1.5;
          max-width: 500px;
        }

        /* Room Selection (hidden by default) */
        .room-selection {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: #0c1317;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }

        .room-container {
          background: #202c33;
          padding: 40px;
          border-radius: 8px;
          width: 90%;
          max-width: 500px;
          text-align: center;
        }

        /* Responsive */
        @media (max-width: 900px) {
          .sidebar {
            width: 380px;
            min-width: 320px;
          }
        }

        @media (max-width: 768px) {
          .whatsapp-container {
            flex-direction: column;
          }
          
          .sidebar {
            width: 100%;
            height: 40%;
            border-right: none;
            border-bottom: 1px solid #222d34;
          }
          
          .chat-main {
            height: 60%;
          }
        }

        @media (max-width: 480px) {
          .sidebar {
            min-width: unset;
          }
          
          .message {
            max-width: 80%;
          }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <!-- Room Selection Screen -->
    <div id="room-selection" class="room-selection">
        <div class="room-container">
            <div class="welcome-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="welcome-text">
                <h1>WhatsApp-style Chat</h1>
                <p>Built with Cloudflare Durable Objects</p>
                
                <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 15px;">
                    <input type="text" id="username-input" placeholder="Your name" class="message-input" style="text-align: center; margin-bottom: 10px;">
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button id="public-room-btn" class="send-button" style="width: auto; padding: 10px 20px; border-radius: 8px; flex: 1;">
                            <i class="fas fa-globe"></i> Public Room
                        </button>
                        <button id="private-room-btn" class="send-button" style="width: auto; padding: 10px 20px; border-radius: 8px; flex: 1; background: #53bdeb;">
                            <i class="fas fa-lock"></i> Private Room
                        </button>
                    </div>
                    
                    <div id="room-name-container" style="display: none;">
                        <input type="text" id="room-name-input" placeholder="Room name" class="message-input" style="text-align: center;">
                        <button id="join-room-btn" class="send-button" style="width: auto; padding: 10px 20px; border-radius: 8px; margin-top: 10px;">
                            <i class="fas fa-sign-in-alt"></i> Join Room
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main WhatsApp Container -->
    <div class="whatsapp-container" style="display: none;">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="profile-avatar" id="user-avatar">U</div>
                    <div class="profile-name" id="user-name">User</div>
                </div>
                <div class="sidebar-actions">
                    <i class="fas fa-users" title="Group info"></i>
                    <i class="fas fa-ellipsis-v" title="Menu"></i>
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search or start new chat">
                </div>
            </div>

            <div class="contact-list" id="contact-list">
                <!-- Contacts will be populated here -->
                <div class="contact-item active">
                    <div class="contact-avatar">GC</div>
                    <div class="contact-info">
                        <div class="contact-header">
                            <div class="contact-name" id="current-room-name">General Chat</div>
                            <div class="contact-time" id="room-time">Now</div>
                        </div>
                        <div class="contact-preview">
                            <div class="contact-message" id="room-preview">Click to join the conversation</div>
                            <div class="unread-badge" id="unread-count">3</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Welcome Screen (shown when no room selected) -->
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="welcome-text">
                    <h1>WhatsApp-style Chat</h1>
                    <p>Send and receive messages without keeping your phone online.<br>
                    Use WhatsApp on up to 4 linked devices and 1 phone at the same time.</p>
                    <p style="margin-top: 20px; font-size: 12px; color: #8696a0;">
                        <i class="fas fa-lock"></i> Built with Cloudflare Durable Objects â€¢ End-to-end encrypted
                    </p>
                </div>
            </div>

            <!-- Active Chat (hidden by default) -->
            <div class="chat-active" id="chat-active" style="display: none; flex: 1; flex-direction: column; height: 100%;">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-partner">
                        <div class="partner-avatar" id="room-avatar">GC</div>
                        <div class="partner-info">
                            <h3 id="active-room-name">General Chat</h3>
                            <p id="active-room-users">3 participants</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <i class="fas fa-search" title="Search"></i>
                        <i class="fas fa-ellipsis-v" title="Menu"></i>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="messages-container" id="messages-container">
                    <div class="date-separator">TODAY</div>
                    
                    <!-- Messages will be inserted here -->
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-container">
                    <div class="input-actions">
                        <i class="far fa-smile" id="emoji-btn" title="Emoji"></i>
                        <i class="fas fa-paperclip" id="attach-btn" title="Attach"></i>
                    </div>
                    <textarea class="message-input" id="message-input" placeholder="Type a message"></textarea>
                    <button class="send-button" id="send-button" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let currentUser = null;
        let currentRoom = null;
        let ws = null;
        let isTyping = false;
        let typingTimeout = null;
        let onlineUsers = new Map();
        
        // DOM Elements
        const roomSelection = document.getElementById('room-selection');
        const whatsappContainer = document.querySelector('.whatsapp-container');
        const usernameInput = document.getElementById('username-input');
        const publicRoomBtn = document.getElementById('public-room-btn');
        const privateRoomBtn = document.getElementById('private-room-btn');
        const roomNameContainer = document.getElementById('room-name-container');
        const roomNameInput = document.getElementById('room-name-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatActive = document.getElementById('chat-active');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const currentRoomName = document.getElementById('current-room-name');
        const activeRoomName = document.getElementById('active-room-name');
        const activeRoomUsers = document.getElementById('active-room-users');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const roomAvatar = document.getElementById('room-avatar');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            setupMessageInput();
        });
        
        function setupEventListeners() {
            // Room selection
            publicRoomBtn.addEventListener('click', () => {
                if (!usernameInput.value.trim()) {
                    alert('Please enter your name');
                    usernameInput.focus();
                    return;
                }
                roomNameContainer.style.display = 'block';
            });
            
            privateRoomBtn.addEventListener('click', () => {
                if (!usernameInput.value.trim()) {
                    alert('Please enter your name');
                    usernameInput.focus();
                    return;
                }
                createPrivateRoom();
            });
            
            joinRoomBtn.addEventListener('click', () => {
                if (!roomNameInput.value.trim()) {
                    alert('Please enter a room name');
                    roomNameInput.focus();
                    return;
                }
                joinPublicRoom(roomNameInput.value);
            });
            
            // Message input
            messageInput.addEventListener('input', handleMessageInput);
            messageInput.addEventListener('keydown', handleMessageKeydown);
            sendButton.addEventListener('click', sendMessage);
            
            // Emoji button
            document.getElementById('emoji-btn').addEventListener('click', () => {
                // Simple emoji insertion (in a real app, use emoji picker library)
                const emojis = ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡'];
                const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                insertAtCursor(messageInput, randomEmoji);
                messageInput.focus();
            });
        }
        
        function setupMessageInput() {
            messageInput.addEventListener('focus', () => {
                messageInput.parentElement.style.backgroundColor = '#2a3942';
            });
            
            messageInput.addEventListener('blur', () => {
                messageInput.parentElement.style.backgroundColor = '#2a3942';
            });
        }
        
        function handleMessageInput() {
            // Auto-resize textarea
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
            
            // Enable/disable send button
            sendButton.disabled = messageInput.value.trim().length === 0;
            
            // Typing indicator
            if (!isTyping && messageInput.value.length > 0) {
                sendTypingIndicator(true);
                isTyping = true;
            }
            
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                if (isTyping) {
                    sendTypingIndicator(false);
                    isTyping = false;
                }
            }, 1000);
        }
        
        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            } else if (e.key === 'Enter' && e.shiftKey) {
                // Allow new line with Shift+Enter
                return;
            }
            
            // Message history navigation
            if (e.key === 'ArrowUp' && messageInput.value === '') {
                // Could implement message history here
            }
        }
        
        function sendTypingIndicator(typing) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ typing: typing }));
            }
        }
        
        function createPrivateRoom() {
            currentUser = {
                name: usernameInput.value.trim(),
                avatar: usernameInput.value.trim().charAt(0).toUpperCase()
            };
            
            // Generate random room ID (in real app, call API)
            const roomId = Math.random().toString(36).substring(2, 15);
            currentRoom = {
                id: roomId,
                name: 'Private Room',
                type: 'private'
            };
            
            initializeUI();
            simulateJoinRoom();
        }
        
        function joinPublicRoom(roomName) {
            currentUser = {
                name: usernameInput.value.trim(),
                avatar: usernameInput.value.trim().charAt(0).toUpperCase()
            };
            
            currentRoom = {
                id: roomName.toLowerCase().replace(/[^a-z0-9]/g, '-'),
                name: roomName,
                type: 'public'
            };
            
            initializeUI();
            simulateJoinRoom();
        }
        
        function initializeUI() {
            // Hide room selection, show main app
            roomSelection.style.display = 'none';
            whatsappContainer.style.display = 'flex';
            
            // Set user info
            userAvatar.textContent = currentUser.avatar;
            userName.textContent = currentUser.name;
            
            // Set room info
            currentRoomName.textContent = currentRoom.name;
            activeRoomName.textContent = currentRoom.name;
            roomAvatar.textContent = currentRoom.name.charAt(0).toUpperCase();
            
            // Show chat interface
            welcomeScreen.style.display = 'none';
            chatActive.style.display = 'flex';
            
            // Focus message input
            setTimeout(() => {
                messageInput.focus();
            }, 100);
        }
        
        function simulateJoinRoom() {
            // Add welcome messages
            addSystemMessage(`Welcome to ${currentRoom.name}!`, 'join');
            addSystemMessage('This is a WhatsApp-style chat interface using Cloudflare Durable Objects.', 'info');
            addSystemMessage('Type a message to start chatting!', 'info');
            
            // Simulate other users joining
            setTimeout(() => {
                addMessage('System', 'Alice joined the chat', false, true);
                onlineUsers.set('Alice', { name: 'Alice', avatar: 'A' });
                updateOnlineUsers();
            }, 1000);
            
            setTimeout(() => {
                addMessage('System', 'Bob joined the chat', false, true);
                onlineUsers.set('Bob', { name: 'Bob', avatar: 'B' });
                updateOnlineUsers();
            }, 2000);
            
            setTimeout(() => {
                addMessage('Alice', 'Hello everyone! ðŸ‘‹', false, false);
            }, 3000);
            
            setTimeout(() => {
                addMessage('Bob', 'Hi there! How is everyone doing?', false, false);
            }, 4000);
            
            // Initialize WebSocket (simulated)
            initializeWebSocket();
        }
        
        function initializeWebSocket() {
            // In a real implementation, this would connect to your Durable Objects backend
            // For this demo, we'll simulate WebSocket behavior
            
            console.log('WebSocket would connect to room:', currentRoom.id);
            
            // Simulate incoming messages
            setInterval(() => {
                if (Math.random() > 0.7 && onlineUsers.size > 0) {
                    const users = Array.from(onlineUsers.keys());
                    const randomUser = users[Math.floor(Math.random() * users.length)];
                    const messages = [
                        'How are you doing?',
                        'This chat UI looks great!',
                        'Has anyone tried the new features?',
                        'I think this is working well!',
                        'What do you think about this layout?',
                        'The WhatsApp-style positioning is nice on desktop',
                        'This would be perfect with real Durable Objects backend'
                    ];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    
                    addMessage(randomUser, randomMessage, false, false);
                }
            }, 15000);
        }
        
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUser) return;
            
            // Add own message to UI immediately
            addMessage(currentUser.name, text, true, false);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendButton.disabled = true;
            
            // Send via WebSocket (simulated)
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ message: text }));
            }
            
            // Stop typing indicator
            if (isTyping) {
                sendTypingIndicator(false);
                isTyping = false;
            }
            if (typingTimeout) clearTimeout(typingTimeout);
            
            // Simulate responses
            if (text.toLowerCase().includes('hello') || text.toLowerCase().includes('hi')) {
                setTimeout(() => {
                    const users = Array.from(onlineUsers.keys());
                    if (users.length > 0) {
                        const randomUser = users[Math.floor(Math.random() * users.length)];
                        addMessage(randomUser, 'Hello there!', false, false);
                    }
                }, 1000);
            }
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        function addMessage(sender, text, isOwn = false, isSystem = false) {
            if (isSystem) {
                addSystemMessage(text, 'info');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'outgoing' : 'incoming'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender.charAt(0).toUpperCase();
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'message-info';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const statusSpan = document.createElement('span');
            statusSpan.className = 'message-status';
            statusSpan.innerHTML = isOwn ? 'âœ“âœ“' : '';
            
            infoDiv.appendChild(timeSpan);
            infoDiv.appendChild(statusSpan);
            
            contentDiv.appendChild(bubble);
            contentDiv.appendChild(infoDiv);
            
            if (!isOwn) {
                messageDiv.appendChild(avatar);
            }
            messageDiv.appendChild(contentDiv);
            if (isOwn) {
                messageDiv.appendChild(avatar);
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addSystemMessage(text, type = 'info') {
            const systemDiv = document.createElement('div');
            systemDiv.className = `system-message ${type}`;
            systemDiv.textContent = text;
            messagesContainer.appendChild(systemDiv);
            scrollToBottom();
        }
        
        function updateOnlineUsers() {
            activeRoomUsers.textContent = `${onlineUsers.size + 1} participants`;
            
            // Update contact list preview
            document.getElementById('room-preview').textContent = 
                `${onlineUsers.size} other user${onlineUsers.size !== 1 ? 's' : ''} online`;
            document.getElementById('unread-count').textContent = onlineUsers.size;
        }
        
        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;
            
            textarea.value = value.substring(0, start) + text + value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();
            
            // Trigger input event
            const event = new Event('input', { bubbles: true });
            textarea.dispatchEvent(event);
        }
        
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Auto-focus username input
        usernameInput.focus();
    </script>
  </body>
</html>
