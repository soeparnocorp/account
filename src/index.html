<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style type="text/css">
* {
  box-sizing: border-box;
}
body {
  font-family: Arial, Helvetica, sans-serif;
}

#chatlog {
  position: fixed;
  top: 0;
  bottom: 32px;
  left: 200px;
  right: 0;
  overflow-y: auto;
  padding: 8px;
  overflow-wrap: break-word;
}
#chatlog span.username {
  font-weight: bold;
}
#spacer {
  height: calc(100vh - 32px - 5em);
}

#roster {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 32px;
  width: 200px;
  border-right: 1px solid #ccc;
  font-weight: bold;
  padding: 8px;
}

p {
  margin-top: 0;
  margin-bottom: 8px;
}
p:last-of-type {
  margin: 0;
}

::-webkit-scrollbar {
  display: none;
}

@media(max-width:600px) {
  #roster {
    display: block;
    width: 100%;
    left: 0;
    right: 0;
    border-right: none;
  }
  #chatlog {
    display: none;
  }
  #chat-input {
    display: none;
  }
  #chatroom::before {
    display: none;
  }
}

#chat-input {
  position: fixed;
  width: 100%;
  height: 32px;
  bottom: 0;
  left: 0;
  border: none;
  border-top: none;
  padding-left: 32px;
  outline: none;
}
#chatroom::before {
  z-index: 1;
  display: block;
  content: ">";
  position: fixed;
  bottom: 0;
  left: 0;
  width: 32px;
  height: 32px;
  line-height: 32px;
  text-align: center;
  font-weight: bold;
  color: #888;
  -webkit-text-stroke-width: 2px;
}

#room-form {
  position: fixed;
  z-index: 3;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: white;
  font-size: 200%;
  margin-top: calc(50vh - 3em);
  text-align: center;
}

#room-name {
  font-size: inherit;
  border: 1px solid #bbb;
  height: 2em;
  width: 16em;
  padding-left: 1em;
}

#room-form button {
  font-size: inherit;
  border: 1px solid #bbb;
  background-color: #eee;
  height: 2em;
}

#name-form {
  position: fixed;
  z-index: 2;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: white;
  display: none;
}

#name-input {
  position: fixed;
  font-size: 200%;
  top: calc(50% - 1em);
  left: calc(50% - 8em);
  width: 16em;
  height: 2em;
  margin: 0;
  text-align: center;
  border: 1px solid #bbb;
}

#name-form p {
  position: fixed;
  top: calc(50% + 3em);
  width: 100%;
  text-align: center;
}

@media(max-width:660px) {
  #name-input, #room-form { font-size: 150%; }
  #name-form p { font-size: 75%; }
}
@media(max-width:500px) {
  #name-input, #room-form { font-size: 100%; }
  #name-form p { font-size: 50%; }
}

#go-public {
  width: 4em;
}
#go-private {
  width: 20em;
}

</style>
  </head>
  <body>
    <form id="room-form" action="/fake-form-action">
      <p>Public Room:</p>
      <input id="room-name" placeholder="room name"><button id="go-public">Go &raquo;</button>
      <p>OR</p>
      <button id="go-private">Private Room &raquo;</button>
    </form>

    <form id="name-form" action="/fake-form-action">
      <input id="name-input" placeholder="your name">
      <p>This chat runs entirely on the edge<br>
        <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">Durable Objects</a></p>
    </form>

    <form id="chatroom" action="/fake-form-action">
      <div id="chatlog">
        <div id="spacer"></div>
      </div>
      <div id="roster"></div>
      <input id="chat-input">
    </form>

    <div id="settings-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid #ccc; z-index: 1000;">
      <h3>Settings</h3>
      <p>Device ID: <span id="device-id"></span></p>
      <p>Rooms in KV: <span id="kv-count"></span></p>
      <p>Rooms in D1: <span id="d1-count"></span></p>
      <button id="close-settings">Close</button>
    </div>
  </body>

<script type="text/javascript">
let currentWebSocket = null;
let activeRooms = new Map(); // streamId -> room data

let nameForm = document.querySelector("#name-form");
let nameInput = document.querySelector("#name-input");
let roomForm = document.querySelector("#room-form");
let roomNameInput = document.querySelector("#room-name");
let goPublicButton = document.querySelector("#go-public");
let goPrivateButton = document.querySelector("#go-private");
let chatroom = document.querySelector("#chatroom");
let chatlog = document.querySelector("#chatlog");
let chatInput = document.querySelector("#chat-input");
let roster = document.querySelector("#roster");

let isAtBottom = true;
let username;
let currentRoom;
let deviceId = localStorage.getItem('device_id');
let pendingMessages = new Map(); // streamId -> [messages]

if (!deviceId) {
  deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
  localStorage.setItem('device_id', deviceId);
}

let hostname = window.location.host;
if (hostname == "") {
  hostname = "account.soeparnocorp.workers.dev";
}

async function loadPublicRooms() {
  try {
    let response = await fetch(`https://${hostname}/api/rooms`);
    let rooms = await response.json();
    console.log('Public rooms from D1:', rooms);
  } catch (err) {
    console.error('Failed to load rooms:', err);
  }
}

async function loadCachedRooms() {
  try {
    let response = await fetch(`https://${hostname}/api/cache?key=public_rooms`);
    let data = await response.json();
    console.log('Cached rooms from KV:', data);
  } catch (err) {
    console.error('Failed to load cached rooms:', err);
  }
}

function startRoomChooser() {
  if (document.location.hash.length > 1) {
    currentRoom = document.location.hash.slice(1);
    startChat();
    return;
  }

  roomForm.addEventListener("submit", event => {
    event.preventDefault();
    currentRoom = roomNameInput.value;
    if (currentRoom.length > 0) {
      startChat();
    }
  });

  roomNameInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 32) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 32);
    }
  });

  goPublicButton.addEventListener("click", event => {
    currentRoom = roomNameInput.value;
    if (currentRoom.length > 0) {
      startChat();
    }
  });

  goPrivateButton.addEventListener("click", async event => {
    roomNameInput.disabled = true;
    goPublicButton.disabled = true;
    event.currentTarget.disabled = true;

    let response = await fetch("https://" + hostname + "/api/room", {method: "POST"});
    if (!response.ok) {
      alert("something went wrong");
      document.location.reload();
      return;
    }

    currentRoom = await response.text();
    startChat();
  });

  roomNameInput.focus();
}

function startChat() {
  roomForm.style.display = "none";
  nameForm.style.display = "block";

  currentRoom = currentRoom.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

  if (currentRoom.length > 32 && !currentRoom.match(/^[0-9a-f]{64}$/)) {
    addChatMessage("ERROR", "Invalid room name.");
    return;
  }

  document.location.hash = "#" + currentRoom;

  if (window.innerWidth <= 600) {
    roster.style.display = "block";
    chatlog.style.display = "none";
    chatInput.style.display = "none";
  }

  chatInput.addEventListener("keydown", event => {
    if (event.keyCode == 38) {
      chatlog.scrollBy(0, -50);
    } else if (event.keyCode == 40) {
      chatlog.scrollBy(0, 50);
    } else if (event.keyCode == 33) {
      chatlog.scrollBy(0, -chatlog.clientHeight + 50);
    } else if (event.keyCode == 34) {
      chatlog.scrollBy(0, chatlog.clientHeight - 50);
    }
  });

  chatroom.addEventListener("submit", event => {
    event.preventDefault();

    if (currentWebSocket && chatInput.value.trim()) {
      let streamId = "room:" + currentRoom;
      currentWebSocket.send(JSON.stringify({
        type: "message",
        streamId: streamId,
        message: chatInput.value,
        userName: username
      }));
      chatInput.value = "";
      chatlog.scrollBy(0, 1e8);
    }
  });

  chatInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 256) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 256);
    }
  });

  chatlog.addEventListener("scroll", event => {
    isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
  });

  if('visualViewport' in window) {
    window.visualViewport.addEventListener('resize', function(event) {
      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    });
  }

  connectUserWebSocket();

  nameForm.addEventListener("submit", event => {
    event.preventDefault();
    username = nameInput.value;
    if (username.length > 0) {
      localStorage.setItem('username', username);
      
      let streamId = "room:" + currentRoom;
      
      if (currentWebSocket) {
        currentWebSocket.send(JSON.stringify({
          type: "subscribe",
          streamId: streamId,
          roomId: currentRoom
        }));
      }
      
      nameForm.style.display = "none";
      
      if (window.innerWidth <= 600) {
        chatInput.style.display = "none";
      } else {
        roster.style.display = "block";
        chatlog.style.display = "block";
        chatInput.style.display = "block";
        chatInput.focus();
      }
      
      if (pendingMessages.has(streamId)) {
        pendingMessages.get(streamId).forEach(msg => {
          addChatMessage(msg.name, msg.message);
        });
        pendingMessages.delete(streamId);
      }
    }
  });

  nameInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 32) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 32);
    }
  });
}

function connectUserWebSocket() {
  const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
  let ws = new WebSocket(wss + hostname + "/api/user/" + deviceId + "/websocket");
  let rejoined = false;
  let startTime = Date.now();

  let rejoin = async () => {
    if (!rejoined) {
      rejoined = true;
      currentWebSocket = null;

      while (roster.firstChild) {
        roster.removeChild(roster.firstChild);
      }

      let timeSinceLastJoin = Date.now() - startTime;
      if (timeSinceLastJoin < 10000) {
        await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
      }

      connectUserWebSocket();
    }
  }

  ws.addEventListener("open", event => {
    currentWebSocket = ws;
    
    if (username && currentRoom) {
      ws.send(JSON.stringify({
        type: "subscribe",
        streamId: "room:" + currentRoom,
        roomId: currentRoom
      }));
    }
  });

  ws.addEventListener("message", event => {
    let data = JSON.parse(event.data);

    if (data.error) {
      addChatMessage(null, "* Error: " + data.error);
    } else if (data.type === "joined") {
      if (username) {
        let p = document.createElement("p");
        p.innerText = data.userId;
        roster.appendChild(p);
      }
    } else if (data.type === "quit") {
      for (let child of roster.childNodes) {
        if (child.innerText == data.userId) {
          roster.removeChild(child);
          break;
        }
      }
    } else if (data.type === "message") {
      if (data.data && data.data.timestamp > lastSeenTimestamp) {
        addChatMessage(data.data.name, data.data.message);
        lastSeenTimestamp = data.data.timestamp;
      }
    }
  });

  ws.addEventListener("close", event => {
    console.log("WebSocket closed, reconnecting:", event.code, event.reason);
    rejoin();
  });
  ws.addEventListener("error", event => {
    console.log("WebSocket error, reconnecting:", event);
    rejoin();
  });
}

let lastSeenTimestamp = 0;
let wroteWelcomeMessages = false;

function addChatMessage(name, text) {
  let p = document.createElement("p");
  if (name) {
    let tag = document.createElement("span");
    tag.className = "username";
    tag.innerText = name + ": ";
    p.appendChild(tag);
  }
  p.appendChild(document.createTextNode(text));

  chatlog.appendChild(p);
  if (isAtBottom) {
    chatlog.scrollBy(0, 1e8);
  }
}

loadPublicRooms();
loadCachedRooms();
startRoomChooser();
</script>
</html>
